# 计算机网络复习

> 要回顾就详细地回顾，打破砂锅问到底=爽
>
> 推荐想继续再深入的可以再看看《计算机网络-自顶向下方法》和《TCP/IP详解卷1：协议》，后续看情况也会整理对应的笔记。

## 0. 计算机网络概述

### 0.1 网络组成

1. 边缘部分

   + 客户服务器方式C/S
   + 对等方式P2P

2. 核心部分

   + 电路交换

     建立连接（申请占用通信资源）-> 通话（一直占用通信资源） -> 释放连接（释放通信资源）

     适合数据量很大的实时性传输，==核心路由器之间可以使用电路交换==。

     建立连接后，一次性发送所有数据。

   + 报文交换

     每个中间路由器需要重新发送整个完整的报文。

   + 分组交换

     将报文拆分成多个分组后，每个中间路由器需要重新发送整个完整的分组。由于分组更小，时延也就更小。

     （理想情况下，比如一个报文平均分4分，从起点到终点，中间需要经过2路由时，那么第一个路由收到分组1，马上接收分组2，并且把分组1发送到第二个中间路由器。）

## 1. 计算机网络体系结构

### 1.1 OSI七层模型

> [协议数据单元PDU]([https://baike.baidu.com/item/%E5%8D%8F%E8%AE%AE%E6%95%B0%E6%8D%AE%E5%8D%95%E5%85%83/8226389?fromtitle=PDU&fromid=1855#viewPageContent](https://baike.baidu.com/item/协议数据单元/8226389?fromtitle=PDU&fromid=1855#viewPageContent))

1. 物理层：电压、接口标准。位流(bit流)传输。
2. 数据链路层：数据如何封装，添加物理层地址（MAC）、碰撞检测、指数退让。数据帧传输。
   + ARP、RARP（功能上网络层，实际实现、工作是数据链路层）
3. 网络层：IP地址编址、选择最佳路径。分组传输（分组就是拆分报文，然后添加一些首部信息，这样获得所有分组后，可以按照顺序组合回成更高层的报文）
   + IP、ICMP
4. 传输层：可靠传输TCP（需建立会话）、不可靠传输UDP、流量控制。报文传输。
   + TCP、UDP
5. 会话层：服务和用户建立的绘画(ps:使用netstat -nb 可以检测主机建立连接的程序)
6. 表示层：数据加密、压缩。
7. 应用层：产生网络流量、与用户交互，传输PDU（可以理解为文件、电影、图片什么的）。
   + HTTP、FTP、STMP

### 1.2 网络安全和OSI参考模型

> [ADSL，Asymmetric Digital Subscriber Line](https://baike.baidu.com/item/ADSL/96520)

1. 物理层安全：比如整个办公楼的网线在装修时，都预留好了，每个楼层有网线接口插座。然后这些网线都连接到地下室的服务器，来上网。哪一天要是中间几层楼出租给别的公司了，那么这些公司要是也直接用这些网线，就能访问到地下室的服务器了，这样子地下室的服务器就可能被攻击。（解决方式：可以直接在地下室服务器上拔掉这条网线接口。）
2. 数据链路层安全：ADSL、AP密码等。
   1. ADSL，用户通过电话拨号上网，需要输入账号密码。这个账号密码和应用层的邮箱系统的账号密码是不同级别的。
   2. 无线AP，无线网卡。要是没有密码，那么每个人都可以通过笔记本的无线网卡，直接WiFi蹭别人的网了。

3. 网络层安全：IP限制网络访问。比如某公司限制研发部的IP网段可以连接外网，而运维部的IP网段不能访问外网。（可以通过防火墙实现IP限制等）

7. 应用层安全：SQL注入漏洞、上传漏洞、XSS攻击等。SQL注入比如数据库模糊查询；上传漏洞比如上传PHP文件，然后被服务器解释并运行。

## 2. 物理层

### 2.1 物理层基本概念

​	物理层解决如何在连接各种计算机的传输媒体上传输**数据比特流**的问题，而不是值具体的传输媒体。

​	物理层的主要任务描述为：确定与传输媒体的接口的一些特性，即：

+ 机械特性：例接口形状、大小、引线数目
+ 电气特性：例规定电压范围（-5V~5V）
+ 功能特性：例规定-5V表示0，+5V表示1
+ 过程特性：也称规程特性，规定建立连接时各个相关部件的工作步骤

### 2.2 基础知识

1. #### 典型的数据通信模型

   输入数据 --> PC --数字比特流(bit)--> 调制解调器--模拟信号-->公用电话网--模拟信号-->调制解调器--数字比特流--> PC --> 显示数据

2. #### 相关术语

   > [数字信号与模拟信号的区别是什么？](https://zhidao.baidu.com/question/857445.html)
   >
   > 其实最明显的区别就是数字信号是离散变化的，模拟信号是连续的。
   >
   > 数字信号的改变没有体现中间过程的弧线，就是垂直的上凸下凹的图，或者纯数字；
   >
   > 模拟信号的改变能体现中间变化过程，是连续的弯曲弧状波形。->需要采样、量化才能转化成数字信号。
   >
   > **数字信号的抗干扰性强**，就算波形变化大，只要能判断是凹还是凸即可分辨出01，而模拟信号不能直接根据凹凸情况判断01，如果波形变化大，就更容易失真了。

   > [只有模拟信号才有码元的概念吗](https://zhidao.baidu.com/question/1888737754927484548.html)
   > 首先自然界是没bai有数字信号du的 数字信号是为了处理zhi器处理而出现的 所以要先对模拟信号dao采样得到数字信号
模拟信号转数字信号要经过：采样-量化-编码 再将得到的数字信号按需要处理后转回模拟信号 编码就是对量化后的电平用编码形式表示称为码元
奈奎斯特定律说明了采样要求 当采样频率fs.max大于信号中最高频率fhmax的2倍时(fs.max>2fhmax) 采样之后的数字信号完整包含了模拟信息 不会发生频谱混叠
   
   通信的目的就是传送信息。
   
   数据（data）——运送信息的实体。
   
   信号（signal）——数据的**电气**的或**电磁**的表现。*（比如电压高低表示1和0，光纤光信号）*

   + **模拟信号**：代表消息的参数的取值是连续的。*（比如声音的波状图）*
   
   + **数字信号**：代表信息的参数的取值是离散的。*（比如数字0，1，2，5，10之类的）*
   
   **码元**（code）——在**使用时间域的波形**<u>表示数字信号</u>时，则代表不同离散数值的基00本波形就成为码元。
   
   在数字通信中常常用时间间隔相同的符号来表示一个二进制的数字，这样的时间间隔内的信号称为二进制码元。而这个间隔被称为码元长度。**1码元可以携带nbit的信息量**。
   
   ```none
   # 码元 ，就这种上下垂直的波状的图，与模拟信号那种连续的波状不同
   ┏━━┓    ┏━━┓   ┏━━┓
   ┃  ┃▁▁┃  ┃▁▁┃  ┃
   ```
   
   > [数字信号与模拟信号的区别是什么？](https://zhidao.baidu.com/question/857445.html)
   >
   > 1、**数字信号在传输过程中不仅具有较高的抗干扰性，还可以通过压缩，占用较少的带宽，实现在相同的带宽内传输更多、更高音频、视频等数字信号的效果**。此外，数字信号还可用半导体存储器来存储，并可直接用于计算机处理。若将电话、传真、电视所处理的音频、文本、视频等数据及其他各种不同形式的信号都转换成数字脉冲来传输，还有利于组成统一的通信网。
   >
   > 2、模拟信号传输过程中,先把信息信号转换成几乎“一模一样”的波动电信号(因此叫“模拟”),再通过有线或无线的方式传输出去,电信号被接收下来后,通过接收设备还原成信息信号。
   
3. #### 信道

   **信道一般表示向一个方向传送信息的媒体。所以咱们说平常的通信线路往往包含一条发送信息的信道和一条接收信息的信道**。

   + 单工通信（单向通信）：只能有一个方向的通信而没有反方向的交互。*（比如无线电广播，由广播台到收音机）*
   + 半双工通信（双向交替通信）：通信的双方都可以发送信息，但不能双方同时发送（接收）。*（比如对讲机）*
   + 全双工通信（双向同时通信）：通信的双方可以同时发送和接收信息。*（比如电话）*

4. #### 基带（baseband）信号和带通（band pass）信号

   > [为什么无线电通信要将低频信号调制到高频传输？](https://blog.csdn.net/li975242487/article/details/93859799)
   >
   > [什么是高频，什么是低频？](https://zhidao.baidu.com/question/495759961339275564.html)
   >
   > [2.4GWIFI和5G WIFI 有什么区别](https://www.bilibili.com/video/BV1qJ411T7ZQ/?spm_id_from=333.788.videocard.1)
   >
   > [Wi-Fi 网络中，2.4GHz 和 5GHz 各自有哪些优缺点？](https://www.zhihu.com/question/20001576)
   >
   > 5GHz WiFi频率更高（传播范围更小）-> 不重叠的频段更多(抗干扰好，传统2.4GHz仅使用3不重叠频段，5GHz使用22个频段) -> 速度快

   + 基带信号（基本频带信号）——**来自信源的信号**。像计算机输出的代码各种文字或图片文件的数据信号都属于基带信号。**基带信号就是发出的直接表达了要传输的信息的信号**，比如我们说话的声波就是基带信号。

   + 带通信号——把基带信号经过**载波调制**后，把信号的频率范围搬移到<u>较高的频段</u>以便在信道中传输（即仅在一段频率范围内能够通过信道）。

   由于在近距离范围内基带信号的衰减不大，从而信号内容不会发生变化，因此**在传输距离较近时，计算机网络都采用基带传输方式**。如从计算机到显示器、打印机等外设的信号就是基带传输的。

   ---

   + 高频（HF，High frequency）：是频率在3 ~ 30MHz 之间的信号频率，这只是对高频的狭隘理解。而高频是包括3MHz到X00GHz的频率范围都可以称为高频。
   + 低频（LF，Low frequency）：是指频带由30 KHz到300 KHz的无线电电波。

   **频率越高，传输损耗越大（比如穿透墙壁损耗能量大，导致最后获取到的信号基本是那少部分衍射、反射过来的信号），覆盖距离越小，绕射能力越弱（原理是衍射）**。

   低频段资源紧张，低频段的无线电波主要用于广播、点视、寻呼等系统。

   > [为什么无线电通信要将低频信号调制到高频传输？](https://blog.csdn.net/li975242487/article/details/93859799)
   >
   > - 基带信号频率低，波长长，当天线的长度为无线电信号波长的 1/4 时，天线的发射和接收转换效率最高，如果不调制到高频，天线需要做得很长；
   > - 空间中的频谱资源是有限的，每个信道都严格划分给固定用途，通过载波调制可以选择合适的信道进行传输；
   > - 高频要比低频传送的成本低效率高。利用高频的不同的载波，容易实现多路通信。

5. #### 几种基本的调制方法

   1. 调幅（AM）：载波的**振幅**随基带数字信号而变化。
   2. 调频（FM）：载波的**频率**随基带数字信号而变化。
   3. 调相（PM）：载波的**初始相位**随基带数字信号而变化。

6. #### 数据通信常用编码

   1. 单极性不归零码
   2. 双极性不归零码
   3. 单极性归零码
   4. 双极性归零码
   5. 曼彻斯特编码：一个时钟周期只可表示一个bit，并且必须通过两次采样才能得到一个bit，但它能携带时钟信号，且可表示没有数据传输。（*最前面3种没数据传输了的时候和传输0的时候，都是保持在表示0的那个电压/电平，无法区分数据到底是否结束传输了，不利于同步*）
   6. 差分曼彻斯特编码：**与曼彻斯特编码相同（其实也不完全一样就是了），但抗干扰性能强于曼彻斯特编码**。

7. #### 信道的极限容量

   + 信号在实际信道（带宽受限、有噪音、干扰和失真）传输，往往接收信号波形会相对发送信号波形有不同程度的失真。

   + **奈氏准则：在任何信道中，==码元==传输的速率是有上限的，否则就会出现码间串扰的问题，使接收端对码元的判决（即识别）成为不可能**。*（比如录音后，3倍速播放，就听不清楚）*

   $$
   理想低通信道的最高码元传输速率 = 2W Baud
   $$

   ​			+ W是理想低通信道的带宽，单位HZ

   ​			+ **Baud是波特，是码元传输速率的单位**（若一个码元含有n个bit的信息量，那么1Baud = n bit/s）

   + 波特Baud与bit的区别：在**调制解调器**中经常用到波特Baud这个概念。bit是信息量，如果一个码元含有3个bit信息量，那么这个时候1波特Baud=3bit/s。

     *（比如光猫->光调制解调器，PC把数字信号通过光猫转模拟信号到网络传输，光猫在把接收到的模拟信号转回数字信号传到PC）*

8. #### 信噪比

   **香农(Shannon)用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率**。
   $$
   信道的极限信息传输速率C=Wlog2(1+S/N)b/s
   $$

   + W为信道的带宽，单位HZ
   + S为信道内所传信号的平均功率
   + N为信道内部的高斯噪声功率

   香农公式标明：*（土话说就是，周围噪音大的时候，语速放慢勉强能听清楚。比如你边放音乐边讲话，别人0.5倍速听你的讲话录音能勉强听清楚）*

   1. 信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。
   2. 只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种方法来实现无差错的传输。
   3. 若信道带宽W或信噪比S/N没有上限（当然实际信道不可能如此），则信道的极限信息传输速率C也就没有上限。
   4. 实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少。

9. #### 奈氏准则和香农公式的应用范围

   ```none
   {1}输入信息->{2}[[源点]]->{3}输入数据(数字信号)->{4}[[发送器(调制)]]->{5}发送信号(模拟信号)=>{6}[[传输系统]]=>{7}接收信号(模拟信号)->{8}[[接收器(解调)]]->{9}输出数据(数字信号)->{10}[[终点]]->{11}输出信息
   
   {5}~{7},码元传输速率受奈氏准则的限制(只作用于模拟信号)
   {3}~{9},信息传输速率受香农公式的限制(作用于数字信号、模拟信号)
   ```

   简言之：

   + **奈氏准则：作用于模拟信号**（信道上的==码元==传输，前面说过了，码元即使用时间域的波形来表示数字信号，代表不同离散数数值的基本波形就是码元。）
   + **香农公式：作用于数字信号和模拟信号**

### 2.3 传输媒体

1. 导向传输媒体

   导向传输媒体中，**电磁波**沿着固定媒体传播。

   1. 双绞线

      + 屏蔽双绞线STP（抗干扰性较无屏蔽双绞线UTP更强）
      + 无屏蔽双绞线UTP

   2. 同轴电缆

      + 50Ω同轴电缆，用于数字传输，由于多用于基带传输，也叫基带同轴电缆；
      + 75Ω同轴电缆，用于模拟传输，即宽带同轴电缆；

   3. 光缆

      + 单模光纤：只传输一种电磁波模式。
      + 多模光纤：可传输多个电磁波模式。

      实际上，单模光纤和多模光纤的不同点，即纤芯直径大小，**单模细、多模粗**。**在有线点视网络中使用的光纤全是单模光纤，其传播特性好，带宽可达10GHZ**，可以在一根光纤中传输60套PAL-D电视节目。

2. 非导向传输媒体

   <u>非导向传输媒体就是指自由空间，其中的==电磁波传输被称为无线传输==</u>。**无线传输所使用的频段很广**。

   + **短波通信主要是靠电离层的反射，但短波通道的通信质量较差**。*（毕竟靠的反射，肯定会有部分损耗掉了）*

   + **微波在空间主要是直线传播**。*（地球是圆的，多建几个很高的发送塔接收和发送微波就可以了）*
     + 地面微波接力通信
     + 卫星通信

3. 集线器Hub

   + 工作特点：在网络中只起到信号放大和重发的作用，目的是扩大网络的传输范围，不具备信号的定向发送能力。

     *假如ABCD连接Hub，那么A->B的数据，B、C、D都会收到。一方面阻塞其他主机的传输线路，一方面其他主机若主动抓包数据会导致信息泄露。如果集线器总带宽12M，那么这里ABCD平均带宽只有3M*

   + 最大传输距离：100m*（不同的型号不同）*

   + 集线器是一个大的冲突域
   
   > [网段--百度百科]([https://baike.baidu.com/item/%E7%BD%91%E6%AE%B5](https://baike.baidu.com/item/网段))
   >
   > [中继器--百度百科]([https://baike.baidu.com/item/%E4%B8%AD%E7%BB%A7%E5%99%A8?sefr=cr](https://baike.baidu.com/item/中继器?sefr=cr))

### 2.4 ==信道复用==

> [为什么要使用信道复用技术，常用的信道复用技术有哪些](https://zhidao.baidu.com/question/165577074.html)
>
> <small>时分复用技术与频分复用技术一样，有着非常广泛的应用，电话就是其中最经典的例子，此外时分复用技术在广电也同样取得了广泛地应用，如SDH，ATM，IP和HFC网络中CM与CMTS的通信都是利用了时分复用的技术。</small>
>
> SDH技术可真正实现租用电路的[带宽](https://baike.baidu.com/item/带宽)保证，安全性方面也优于VPN等方式。
>
> 中国移动、电信、[联通](https://baike.baidu.com/item/联通)、广电等电信运营[商都](https://baike.baidu.com/item/商都)已经大规模建设了基于SDH的骨干[光传输](https://baike.baidu.com/item/光传输)网络。

1. #### 频分复用FDM(Frequency Division Multiplexing)

   ​	不同的基带模拟信号通过不同调制器（modulator）进行调制，调成高频信号后，和其他载波调制后的高频信号合并后传输。由于合并前，每个信号所使用的频带不同，获取方根据不同的调制器针对不同频带解调，既可获取之前传输的基带模拟信号。

   > 不同频段不同用户

2. #### 时分复用TDM(Time Division Multiplexing)

   时分复用是将时间划分成一段段**等长**的时分复用帧(TDM帧)。

   每一个时分复用的用户在每一个TDM帧中占用**固定序号**的时隙。

   每一个用户所占用的时隙**周期性**地出现（其周期就是TDM帧的长度对应的时间）

   TDM信号也称为等时(isochronous)信号。

   **时分复用的所有用户是在不同的时间占用同样的频带宽度**。*（可能会造成线路资源的浪费，因为即时某几个用户不交互数据了， 依旧占有时间片）*

   > 同一频段下，不同时间片不同用户

3. #### 统计时分复用STDM(Statistic TDM)

   > [统计时分多路复用]([https://baike.baidu.com/item/%E7%BB%9F%E8%AE%A1%E6%97%B6%E5%88%86%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/16600620?fromtitle=STDM&fromid=5495477&fr=aladdin](https://baike.baidu.com/item/统计时分多路复用/16600620?fromtitle=STDM&fromid=5495477&fr=aladdin))

   根据用户实际需要动态分配线路资源的时分复用方法。只有当用户有数据要传输时才给他分配线路资源，当用户暂停发送数据时，不给他分配线路资源，线路的传输能力可以被其他用户使用。采用统计时分复用时，每个用户的数据传输速率可以高于平均速率，最高可达到线路总的传输能力。

4. #### 波分复用WDM(Wavelength Division Multiplexing)

   本质上就是光的频分复用。

5. #### 码分复用CDM(Code Division Multiplexing)

   常用的名次是码分多址CDMA(Code Division Multiplexing Access)。

   各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。

   这种系统发送的信息有**很强的抗干扰能力**，其频谱类似于白噪声，不易被敌人发现。

   **每一个比特时间划分为m个短的间隔，称为码片（chip）**。
   
   *（原本1bit数据0or1需要至少m个bit去表示。码分复用也是类似频分复用一样，多个用户只要码型不同，发送的数据叠加后在网络传输，也能再根据不同的码型还原回原本的数据）*

> [多址技术--百度百科]([https://baike.baidu.com/item/%E5%A4%9A%E5%9D%80%E6%8A%80%E6%9C%AF/2497170](https://baike.baidu.com/item/多址技术/2497170))
>
> 多址技术是指实现小区内多用户之间，小区内外多用户之间通信地址识别的技术。**多址技术多用于无线通信**。多址技术又称为多址接入技术。
>
> + 频分多址FDMA，早期移动通信采用，各个用户使用不同频率的频道进行通信（信道利用率低）。
> + 时分多址TDMA，现在的**移动通信系统**多数采用这种多址技术。
> + 码分多址CDMA，这种技术比较复杂，但现在已经为不少移动通信系统所采用。在第三代移动通信系统中，也采用宽带码分多址技术。（码分多址一般还会配合其他的一起用）
> + 空分多址SDMA，是一种信道增容的方式，可以实现频率的重复使用，有利于充分利用频率资源。空分多址还可以与其它多址方式相互兼容，从而实现组合的多址技术，例如“空分-码分多址（SD-CDMA）”。
>
> 时分多址是以不同时隙实现通信。码分多址是以不同的代码序列来实现通信的。空分多址是以不同方位信息实现多址通信的。

### 2.5 数据传输系统

脉码调制PCM体制最初是在电话局之间的中继线上传送多路电话。

由于历史上的原理，PCM有两个互不兼容的国际标准，北美的24路PCM（简称T1）和欧洲的30路PCM（简称E1）。我国采用欧洲E1标准。

E1速率2.048Mb/s，而T1速率是1.544Mb/s。

<u>当需要更高的速率时，可采用复用的方法。</u>

### 2.6 宽带接入技术

> [x数字用户线]([https://baike.baidu.com/item/x%E6%95%B0%E5%AD%97%E7%94%A8%E6%88%B7%E7%BA%BF/5929900?fromtitle=xDSL&fromid=10770830&fr=aladdin](https://baike.baidu.com/item/x数字用户线/5929900?fromtitle=xDSL&fromid=10770830&fr=aladdin))
>
> [SDH--百度百科](https://baike.baidu.com/item/SDH/413593)
>
> <small>SDH以其明显的优越性已成为[传输网](https://baike.baidu.com/item/传输网)发展的主流。SDH技术与一些先进技术相结合，如光波分复用（WDM）、[ATM技术](https://baike.baidu.com/item/ATM技术)、Internet技术（Packet over SDH）等，使SDH网络的作用越来越大。SDH已被各国列入21世纪高速[通信网](https://baike.baidu.com/item/通信网)的应用项目，是电信界公认的数字[传输网](https://baike.baidu.com/item/传输网)的发展方向，具有远大的商用前景。</small>

1. xDSL*（比如ADSL，拨号上网）*

   标准模拟电话信号的频带被限制在300~400Hz范围内，单用户线本身实际可通过的信号频率仍然超过1MHz。

   **xDSL技术把0~4kHz低端频谱留给传统电话使用，而把原来没有被利用的高端频谱留给用户上网使用**。

   *（0~4kHZ Voice，26~108kHz Upstream，138~1104kHz Downstream）*

2. HFC网采用结点体系结构（光纤同轴混合网HFC，Hybrid Fiber Coax）

   HFC网是目前覆盖面很广的有线电视网CATV的基础上开发的一种**居民宽带接入网**。

   HFC网除可传送CATV外，还提供电话、数据和其他宽带交互性业务。

   现有额CATV网是树形拓扑结构的同轴电缆网络，它采用**模拟技术的频分复用**对电视节目进行单向传输。而HFC网则需要对CATV网进行改造。

3. FTTx技术

   FFx（光纤到......）也是一种实现宽带居民接入网的方案。*（x可代表不同意思）*

   + 光纤到家（Fiber To The Home）：光纤一直铺设到用户家庭可能是居民接入网最后的解决方法（155Mb/s）。
   + 光纤到大楼（Fiber To The Building）：光纤进入大楼后就转为电信号，然后用电缆或双绞线分配到各用户。
   + 光纤到路边（Fiber To The Curb）：从路边到各用户可使用星形结构双绞线作为传输媒体（155Mb/s）。

> [**遇到的真事，来看看ISP是如何克扣你的带宽的**](http://www.chinadsl.net/forum.php?mod=viewthread&tid=72099)
>
> ADSL（PPPoE验证）：最大下载速度=标称链路速率Kbps\*0.9\*0.95/8
> LAN等（PPPoE验证）：最大下载速度=标称链路速率Kbps\*0.95/8
>
> [运营商对带宽进行限制的原理是怎样的？](https://www.zhihu.com/question/19811707)
>
> [深入探讨网络带宽问题](https://zhuanlan.zhihu.com/p/22875995)
>
> <small>在思科的设备上，某些类型的端口（比如最常用的以太口）默认实际只能使用75%的带宽，剩下那25%是拿来给网络间的各种协议和设备间的通讯用的</small>
>
> [运营商和带宽的那些事](https://zhuanlan.zhihu.com/p/24938843)

## 3. 数据链路层

### 3.1 数据发送模型

主机H1 -------》（ 电话网）-------》路由器R1-------》（局域网）-------》路由器R2-------》（广域网）-------》路由器R3-------》（局域网）-------》主机H2

​	层次上看数据流动，那么只有主机H1和主机H2需要经过TCP/IP五层网络模型，而中间存储和转发的路由器R1~R3仅经过三层（物理层、数据链路层、网络层）

​	**在数据链路层，我们只关心数据帧的传输**，不关心下层物理层采用的传输介质是双绞线、同轴电缆、光纤还是其他，也不关心其信道复用技术采用的是频分多路复用FDM、时分复用TDM、统计时分复用STDM、波分复用WDM、码分多址CDMA还是其他。

### 3.2 数据链路层的信道类别

主要包括两种类别：

1. **点对点信道**：使用一对一的点对点通信方式。*(PPP协议)*
2. **广播信道**：使用一对多的广播通信方式，过程较复杂。广播信道上连接的主机很多，因此必须使用专用的<u>共享信道协议</u>来协调这些主机的数据发送。*(CSMA/CD协议)*

> [PPP （点对点协议(Point to Point Protocol)）--百度百科]([https://baike.baidu.com/item/PPP/6660214?fromtitle=PPP%E5%8D%8F%E8%AE%AE&fromid=1988803&fr=aladdin](https://baike.baidu.com/item/PPP/6660214?fromtitle=PPP协议&fromid=1988803&fr=aladdin))
>
> [CSMA/CD--百度百科](https://baike.baidu.com/item/CSMA%2FCD)

### 3.3 链路和数据链路

> [链路--百度百科]([https://baike.baidu.com/item/%E9%93%BE%E8%B7%AF/9410314?fr=aladdin](https://baike.baidu.com/item/链路/9410314?fr=aladdin))
>
> 链路指无源的点到点的物理连接。
>
> 有线通信时，链路指两个节点之间的物理线路，如电缆或光纤。无线电通信时，链路指基站和终端之间传播电磁波的路径空间。水声通信时链路指换能器和水听器之间的传播声波的路径空间。

+ 链路（link）：是从一个结点到相邻结点的一段物理链路，中间没有任何其他的交换结点。

  *一条链路只是一条通路的一个组成部分。*

+ 数据链路（data link）：除了物理线路(链路)外，还必须有**通信协议**来控制这些数据的传输。若把实现这些协议的<u>硬件和软件</u>加到链路上，就构成了数据链路。

  *现最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。*

  *一般的适配器都包括了<u>数据链路层和物理层</u>这两层的功能。*

### 3.4 数据链路层传输数据--帧

> [帧 （网络术语，表示网络传输单位）--百度百科]([https://baike.baidu.com/item/%E5%B8%A7/23750184#viewPageContent](https://baike.baidu.com/item/帧/23750184#viewPageContent))
>
> 数据在网络上是以很小的称为帧（Frame）的单位传输的，帧由几部分组成，不同的部分执行不同的功能。在以太网数据传输中，节点在发送数据之后的一定时间内，由于传输的非实时性，存在着遭遇碰撞的可能。节点发送的帧很小且2个冲突节点相距很远。
>
> [MTU最大传输单元--百度百科]([https://baike.baidu.com/item/%E6%9C%80%E5%A4%A7%E4%BC%A0%E8%BE%93%E5%8D%95%E5%85%83?fromtitle=mtu&fromid=508920](https://baike.baidu.com/item/最大传输单元?fromtitle=mtu&fromid=508920))
>
> [为什么最小帧长度是64字节](https://blog.csdn.net/jasonchen_gbd/article/details/80170309)
>
> [什么是MTU？为什么MTU值普遍都是1500？](https://blog.csdn.net/passionkk/article/details/100538418)

帧的组成大致如下：

```none
（帧头）（帧数据部分，受MTU限制大小<=1500字节【以太网标准】）（帧尾FCS）
```

*中间的帧数据部分，用于封装上层网络层的IP数据报（或其他网络层数据）。*

数据链路层数据帧传输时，向下至物理层，仍是以普通的数字信号（0101）的形式传输。*至于之后物理层是否转换数字信号为模拟信号，或者把基带信号载波调制成带通信号在高频段传输，信道复用技术采用哪种，无需数据链路层关心。*

### 3.5 数据链路层三大基本问题

1. **封装成帧**
2. **透明传输**
3. **差错检测**（差错控制）

*（现数据链路层一般仅进行差错检测，具体的差错控制->错误重传、纠错等，需要上层实现。主要是避免数据链路层过于臃肿，不利于后面的上层协议设计，且数据链路层要是自主“错误”地多次进行重传、纠错，容易拥塞网络。在某些情况下，数据链路层也提供纠错、重传机制，比如现代的**无线**通信，在链路层采用ARQ协议）*

#### 3.5.1 封装成帧

> [数据链路层的三个基本问题：封装成帧 透明传输 差错检测](https://blog.csdn.net/azsx02/article/details/69387317)

1. 概念：

+ 封装成帧（framing）就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧。

  *（<u>帧头帧尾限界处的字节数据，通常是不可打印的控制字符</u>，尽可能地避免和帧数据部分的内容冲突。）*

  *（接收端数据链路层，根据首部和尾部的标记，从（物理层）比特流中识别帧的开始和结束。）*

+ 首部和尾部的一个重要作用就是进行帧定界。

  *（当然不止如此，不同的数据链路层协议的数据帧的帧头和帧尾的功能不尽相同，通常帧尾内还包括FCS，用于判别数据是否在传输时出现错误）*

2. 思考问题：

   如果帧未发送完，发送端除了问题，只能重发该帧。接收端却接受到了“半截子帧”，它回抛弃吗？为什么？

   答：**不管是接收到含有帧头（SOH）的前半部分“子帧”还是接受到含有帧尾（EOT）的后半部分“子帧”，由于不是一个完整的帧，数据链路层都会抛弃该帧。只有完整地含有帧头（SOH）帧尾（EOT）的帧，才会被保留。**

#### 3.5.2 透明传输

1. 问题

前面**封装成帧**说了，帧头帧尾是不可打印的字符，分别是帧头SOH和帧尾EOT。

+ 若传输的数据是ASCII码中的“可打印字符（共95个）”集时，帧头帧尾的识别不会出现问题。
+ 若传输的数据不是仅由“可打印字符”组成时，就会出现问题。

eg：`【帧头SOH】(帧数据部分....EOT.....)【帧尾EOT】 `该帧被接收端接收时，会将帧数据部分含有的`EOT`字符识别成帧尾，导致后面的所有数据被当作无效帧而丢弃。=> 接收端接收`【帧头SOH】....EOT`，舍弃`.....【帧尾EOT】`。

*（传输二进制数据，比如图片、影视等二进制文件时，就容易出现上述问题）*。

2. 解决方案

+ 字节填充法（byte stuffing）
+ 字符填充法（character stuffing）
+ 零比特填充法
+ ....

这里介绍**字节填充法**：

​	发送端的数据链路层在数据中出现控制字符`SOH`或者`EOT`的前面插入一个不可打印字符*（控制字符）*`ESC`（十六进制编码1B）。

​	*==字节填充==(byte stuffing)或==字符填充==(character stuffing)——**接收端的数据链路层在数据送回网络层之前删除之前插入的转换字符。***

​	如果转义字符也出现数据当中，那么应在转移字符之前插入一个转义字符。当接收端收到连续的两个转义字符时，就删除其中前面的一个。

eg：

`【帧头SOH】(原始数据...EOT...SOH...ECS.....SOH....)【帧尾EOT】`

经过**字节填充**后，预发送的数据如下：

`【帧头SOH】(原始数据...ESC EOT...ESC SOH...ESC ECS.....ESC SOH....)【帧尾EOT】`

#### 3.5.3 差错检测

> [BER （比特出错概率）--百度百科](https://baike.baidu.com/item/BER/20180314)
>
> [信噪比--百度百科]([https://baike.baidu.com/item/%E4%BF%A1%E5%99%AA%E6%AF%94](https://baike.baidu.com/item/信噪比))
>
> <small>狭义来讲是指放大器的输出信号的功率与同时输出的噪声功率的比，常常用分贝数表示，设备的信噪比越高表明它产生的噪声越少。一般来说，信噪比越大，说明混在信号里的噪声越小，声音回放的音质量越高，否则相反。信噪比一般不应该低于70dB，高保真音箱的信噪比应达到110dB以上。</small>

+ 概念

1. 帧在传输过程中，可能产生**比特差错**：1可能会变成0，而0也可能会变成1。*（根据前面物理层的知识，可以猜想是电压突然出现问题，或者高频信号在空气或其他介质中传输收到噪音干扰，等）*

2. 在一段时间内，传输错误的比特占所传输比特总数的比率称为**误码率**BER（Bit Error Rate）。

3. **<u>误码率与信噪比有很大的关系</u>**。*（信噪比SNR，SIGNAL-NOISE RATIO，物理层知识，S/N，S为信道内传输信号的平均功率，N为信道内部的高斯噪音功率，越高越好）*

4. 为了保证数据传输的**可靠性**（比如纠错，或者丢失重传等措施，这些实际由上层协议保证。），在计算机网络传输数据时，必须采用各种差错检测措施。

*（数据链路层只检查出错误帧并丢弃，不纠错，不重传。纠错和重传等其他动作，由上层协议实现。上层对被丢弃的帧无感知。）*

+ 应对手段

  **<u>在帧尾加入冗余校验码</u>FCS**。

  在数据链路层传送的帧中，广泛使用了**循环冗余检验CRC**技术。*(只是其中一种生成FCS的技术)*

  在发送端，先把数据划分为组。假定每组k个比特。假设带传送的一组数据M=101001（现在k=6）。我们在M的后面再添加供差错检测用的n位冗余码一起发送。

  *FSC( frame check sequence)帧检验序列的CRC计算方式*

  + 用二进制的模2运算进行2<sup>n</sup>乘M的运算，这相当于在M后面添加n个0。
  + 得到的（k+n）位的数除以事先选定好的长度为（n+1）位的除数P，得出商是Q而余数是R，余数R比除数P少1位，即R是n位。R就是CRC计算出来的FSC了。

  *（CRC的除数P和冗余码位数n由数据链路层协议商定，无需用户自己指定，理论上除数位数越多相对越可靠。大致知道计算方式即可）*

> [数据链路层的三个基本问题：封装成帧 透明传输 差错检测](https://blog.csdn.net/azsx02/article/details/69387317)
>
> 现实的通信链路都不会是理想的。传输过程中，1可能变成0, 0 可能变成1 。这就叫比特差错。——误码率。 误码率和信噪比有很大的关系。
>
> 因此，在计算机网络传输数据时，必须采用各种差错控制技术。目前在数据链路层广泛使用了循环冗余检验（CRC）的检错技术。
>
> 在数据链路层的CRC检验都是用**硬件**完成的，处理很迅速，因此不会延误数据的传输。
>
> 为什么数据链路层要以帧为单位来传送数据呢？因为如果不以帧为单位，就无法加入冗余码来进行差错检验。
>
> 传输差错分为两类：一类就是前面所说的最基本的比特差错。第二类：收到的帧出现了帧丢失、帧重复和帧失序。（停止等待协议，ARQ）。
>
> 数据链路层并不需要给网络层提供“可靠传输”的服务。<u>过去OSI的观点是：必须让数据链路层向上提供可靠传输。因此在CRC的基础上，增加了帧编号、确认和重传机制。</u>
>
> <u>而现在的互联网采用了区别对待的方法：</u>
>
> <u>对于通信质量良好的**有线**传输链路，数据链路层协议不使用确认和重传机制，即不要求数据链路层向上提供可靠传输的服务。如果在数据链路层传输数据时出现了差错并且需要进行改正，那么改正差错的任务就由上层协议（例如，运输层的TCP协议）来完成。</u>
>
> <u>对于通信质量较差的**无线**传输链路，数据链路层协议使用确认和重传机制，数据链路层向上提供可靠传输的服务。</u>

> [ARQ--百度百科](https://baike.baidu.com/item/ARQ/7402812?fr=aladdin)
>
> 自动重传请求（Automatic Repeat-reQuest，ARQ）是OSI模型中[数据链路层](https://baike.baidu.com/item/数据链路层/4329290)的错误纠正协议之一。它包括停止等待ARQ协议和连续ARQ协议，错误侦测（Error Detection）、正面确认（Positive Acknowledgment）、逾时重传（Retransmission after Timeout）与负面确认继以重传（Negative Acknowledgment and Retransmission）等机制。
>
> 传统[自动重传请求](https://baike.baidu.com/item/自动重传请求)分成为三种，即停等式(stop-and-wait）ARQ，回退n帧（go-back-n）ARQ，以及选择性重传（selective repeat）ARQ。后两种协议是[滑动窗口](https://baike.baidu.com/item/滑动窗口)技术与请求重发技术的结合，由于窗口尺寸开到足够大时，帧在线路上可以连续地流动，因此又称其为[连续ARQ协议](https://baike.baidu.com/item/连续ARQ协议)。三者的区别在于对于出错的数据[报文](https://baike.baidu.com/item/报文)的处理机制不同。三种ARQ协议中，复杂性递增，效率也递增。除了传统的ARQ，还有混合ARQ（Hybrid-ARQ）。
>
> 在现代的无线通信中，ARQ主要应用在**无线**链路层。比如，在WCDMA和cdma2000无线通信中都采用了选择性重传ARQ和混合ARQ。
>
> 优点：比较简单 。因而被广泛的应用在[分组交换](https://baike.baidu.com/item/分组交换)网络中。
>
> 缺点：1.通信信道的利用率不高，也就是说，信道还远远没有被数据比特填满。2.是需要接收方发送ACK，这样增加了网络的负担也影响了传输速度。重复发送[数据包](https://baike.baidu.com/item/数据包)来纠正错误的方法也严重的影响了它的传输速度。

+ 帧检验序列FCS

  在数据后面添加上的冗余码称为**帧检验序列FCS**（Frame Check Sequence）。

  **循环冗余检验CRC（Cyclic Redundancy Check）和帧检验序列FCS并不等同**。

  + CRC是一种常用的**检错方法**，而FCS是添加在数据后面的冗余码。*（只检错，不纠错也不重传）*
  + FCS可以用CRC这种方法得出，但CRC并非是获得FCS唯一方法。

+ 小结：CRC差错检验技术*（其实前面也都讲得很详细了，这里就再总结一下）*

  仅用循环冗余检验CRC差错检测技术只能做到**无差错接受**（accept）。

  + “无差错接受”：“凡是接收到的帧（即不包括被丢弃的帧），我们都能以非常接近于1的概率认为这些帧在传输过程中没有产生差错”。也就是“接收端数据链路层接收到的帧都没有传输差错（有差错的帧就丢弃，不接收了）”。

    *（当然这个只是理想情况，实际就算加了FCS字段，出现数据错误时也可能正好接收端FCS检验计算出来余数也是0-->0表示数据无出错，只不过概率很小。）*

  **要做到“可靠传输”（即发送什么就收到什么），就必须再加上确认和重传机制。**

  + 考虑：帧重复、帧丢失、帧乱序的情况

  **可以说“CRC是一种<u>无比特差错</u>，而不是<u>无传输差错</u>的检验机制”，**

  *（OSI/RM模型的观点：数据链路层要做到无传输差错。）<u>实际上，无线传输时就会考虑在数据链路层实现无传输差错，而有线传输通常只做到无比特差错。</u>*

### 3.6 PPP点对点协议(Point to Point Protocol)

> [PPP点对点协议(Point to Point Protocol)--百度百科](https://baike.baidu.com/item/PPP/6660214#viewPageContent)
>
> 当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接（底层up）。PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
>
> 这些分组及其响应选择一些 PPP 参数，和进行网络层配置（此前如有PAP或CHAP验证先要通过验证），NCP 给新接入的 PC机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
>
> 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。

#### 3.6.1 PPP概述

现在全世界使用得最多的数据链路层协议，是点对点协议PPP（Point to Point Protocol）。

<u>用户使用拨号电话线接入因特网时，一般都是使用PPP协议</u>。

*（补充下，前面物理层的ADSL早期也是用电话线上网，但是能够同时上网和讲电话（频段/频谱不同）；而更早的拨号上网，如果打电话就不能上网，上网就不能打电话，会占用电话线。）*

#### 3.6.2 PPP协议应该满足的要求

+ 简单——这是首要的要求
+ 封装成帧*（注意MTU限制）*
+ 透明性*（透明传输，帧头帧尾判断问题）*
+ 多种网络层协议*（会标识传输的帧数据部分是IP数据报、安全性认证PAP或者其他...）*
+ 多种类型链路*（物理层兼容，光纤、同轴电缆、双绞线等）*
+ 差错检测*（确保无差错接收，CRC等技术）*
+ 检测连接状态*（比如拨号上网，返回各种网络状态信息）*

+ 最大传输单元*（MTU，以太网的标准是<=1500Byte）*

+ 网络层地址协商*（比如拨号上网后，分配IP地址）*
+ 数据压缩协商*（比如多个0或者多个1协商怎么简写表示，然后接收后再还原）*

#### 3.6.3 PPP协议不需要满足的要求

+ 纠错
+ 流量控制
+ 序号
+ 多点线路
+ 半双工或单工链路

#### 3.6.4 PPP协议的组成

```none
3| 上层协议(如IP、IPX、AppleTalk)
-
 | 网络控制协议NCP(针对每一个网络层协议)
2| 链路控制协议LCP
 | 高级数据链路控制协议HDLC(并不是PPP的组成部分，和PPP同样是数据链路层协议)
-
1| 物理层(如 EIA/TIA-232、V.24、V.35 ISDN)
```

+ 数据链路层协议可以用于异步串行或同步串行介质
+ 它使用LCP（链路控制协议）建立并维护数据链路连接
+ 网络控制协议NCP允许在点到点连接上使用多种网络层协议

*（比如ADSL拨号上网，只有LCP身份认证通过了，才能到NCP放行网络层，给你分配IP）*

> [HDLC协议--百度百科]([https://baike.baidu.com/item/HDLC%E5%8D%8F%E8%AE%AE/9441935?fr=aladdin](https://baike.baidu.com/item/HDLC协议/9441935?fr=aladdin))
>
> HDLC协议使用统一的帧格式，运用方便；采用<u>零比特插入法</u>，易于硬件实现，且支持任意的位流传输，实现信息的透明传输；<u>全双工</u>通信，[吞吐率](https://baike.baidu.com/item/吞吐率/1555673)高，在未收到应答帧的情况下，可连续发送信息帧，提高数据链路传输的效率；采用CRC帧校验序列，可防止漏帧，提高信息传输的可靠性。 
>
> 主要有四个特点：
>
> 1·对于任何一种比特流都可透明传输。
>
> 2·较高的数据链路传输效率。
>
> 3·所有的帧都有帧校验序列（[FCS](https://baike.baidu.com/item/FCS/22504028)），传输可靠性高。
>
> 4·用统一的帧格式来实现传输。

#### 3.6.5 PPP协议帧格式

> [PPP点对点协议(Point to Point Protocol)--百度百科](https://baike.baidu.com/item/PPP/6660214#viewPageContent)
>
> PPP采用7EH作为一帧的开始和结束标志（F）；其中地址域（A）和控制域（C）取固定值（A=FFH，C=03H） ；协议域（两个字节）取0021H表示IP分组，取8021H表示网络控制数据，取C021H表示链路控制数据；帧校验域（FCS）也为两个字节，它用于对信息域的校验。若信息域中出现7EH，则转换为（7DH，5EH）两个字符。当信息域出现7DH时，则转换为（7DH，5DH）。当信息流中出现ASCII码的控制字符（即小于20H），即在该字符前加入一个7DH字符。

|      | F(7E) | A(FF) | C(03) | 协议 | 信息部分 | FCS  | F(7E) |
| ---- | ----- | ----- | ----- | ---- | -------- | ---- | ----- |
| 字节 | 1     | 1     | 1     | 2    | <=1500   | 2    | 1     |

*（地址域A取固定值FF很好理解，因为是点到点协议，所以A->B不会出现A->C的情况，链路两端的地址是固定的，没必要特地标识）*

协议字段：

| 字节数据 | 表示类型                  |
| -------- | ------------------------- |
| 0x0021   | PPP帧的信息字段，IP数据报 |
| 0xC021   | 信息字段是PPP链路控制数据 |
| 0x8021   | 表示这是网络控制数据      |
| 0xC023   | 信息字段是安全性认证PAP   |
| 0xC025   | 信息字段是LQR             |
| 0xC223   | 信息字段是安全性认证CHAP  |

#### 3.6.6 PPP的透明传输

1. **字节填充**

   问题：信息字段中出现标志字段的值，可能被误认为是“标志字段”，如何处理？

   + 将信息字段中出现的每个0x7E字节转变成2字节序列（0x7D，0x5E）
   + 若信息字段中出现一个0x7D的字节，则将其转变成2字节序列（0x7D，0x5D）
   + 若信息字段中出现ASCII码的控制字符（即数值小于0x20的字符），则在该字段前面要假如一个0x7D字节，同时将该字符的编码加以改变。

2. **零比特填充方法**

   > [零比特填充法--百度百科]([https://baike.baidu.com/item/%E9%9B%B6%E6%AF%94%E7%89%B9%E5%A1%AB%E5%85%85%E6%B3%95](https://baike.baidu.com/item/零比特填充法))

   PPP协议用在SONET/SDH链路时，是使用同步传输（一连串的比特连续传送）。这时PPP协议采用**零比特填充法**实现透明传输。

   在发送端，只要发现有5个连续1，则立即填入一个0。接收端对帧中的比特进行扫描。每当发现5个连续的1时，就把这5个连续1后的一个0删除。

*字节填充针对传输字节的情况，零比特填充针对传输比特的情况。*

> [SONET和SDH技术简介](https://blog.csdn.net/weixin_43751619/article/details/85008395)
>
> [SONET/SDH--百度百科](https://baike.baidu.com/item/SONET%2FSDH/2231992)
>
> [SONET--百度百科](https://baike.baidu.com/item/SONET/2440753?fr=aladdin)
>
> [SONET/SDH](https://www.jianshu.com/p/9bb81ff4a2ff)
>
> 简言之，即光同步数字传输网，定义了一组在光纤上传输光信号的速率和格式。

#### 3.6.7 PPP不使用序号和确认机制

​	PPP协议之所以不使用序号和确认机制时出于一下的考虑：

+ 在数据链路层出现差错的概率不大时，使用比较简单的PPP协议较为合理。
+ 在**因特网**环境下，PPP的信息字段放入的数据是IP数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
+ 帧检验序列FCS字段可保证无差错接受。

#### 3.6.8 PPP协议的工作状态

​	当用户拨号接入ISP时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。

​	PC机向路由器发送一系列的LCP分组（封装成多个PPP帧）。*(LCP进行身份校验)*

​	<u>这些分组及其响应选择一些PPP参数，和进行网络层配置，NCP给新接入的PC机分配一个临时的IP地址，使PC机成为因特网上的一个主机。</u>

​	<u>通信完毕时，NCP释放网络层连接，收回原来分配出去的IP地址。接着，LCP释放数据链路层连接。最后释放的是物理层的连接。</u>

> [IPCP--百度百科](https://baike.baidu.com/item/IPCP/11049069?fr=aladdin)
>
> [NCP是什么意思？](https://zhidao.baidu.com/question/583045569.html)
>
> [我想问一下，IP地址不是固定的吗，为什么说是网络控制协议NCP临时分配的呢？](https://zhidao.baidu.com/question/2272939370381570788.html)
>
> [TCP/IP：PPP点对点协议中的NCP是干什么用的](https://zhidao.baidu.com/question/258496531.html)
>
> 因特网是由大量的异构网络通过路由器相互连接起来的。而你说的网络层是指的我们用的最多的以太网的网络层，它主要运行IP协议。路由器可以连接不同的网络，即支持不同的网络层协议。所以**PPP链路的两端的NCP根据网络层的不同协议互相交换网络层特定的网络控制分组**。总之，<u>PPP协议两端的网络层可以运行不同的网络层协议，但仍然可使用同一个PPP协议进行通信</u>。
> 如果在PPP链路上运行的是IP协议，则对PPP链路的每一端配置IP协议模块（如分配IP地址）时就要使用NCP中支持IP的协议——IP控制协议**IPCP**(IP Control Protocol)。IPCP分组也封装成PPP帧在PPP链路上传送。

#### 3.6.9 PPP应用举例(cisco packet tracer模拟)

```none
Router1:
	hostname router1
	username router2 password xxx
	interface Serial0
	ip address 192.168.16.1 255.255.255.0
	clockrate 1000000
	ppp authentication chap

Router2:
	hostname router2
	username router1 password xxx
	interface Serial0
	ip address 192.168.16.2 255.255.255.0
	ppp authentication chap
```

### 3.7 局域网

#### 3.7.1 局域网的拓扑结构

+ 星形网
+ 总线网*（最早的以太网Ethernet正是这种）*
+ 环形网*(骨干网络用得多，现局域网用得少)*
+ 树形网
+ ...

> [局域网拓扑结构-百度百科]([https://baike.baidu.com/item/%E5%B1%80%E5%9F%9F%E7%BD%91%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84/10183336?fr=aladdin](https://baike.baidu.com/item/局域网拓扑结构/10183336?fr=aladdin))

#### 3.7.2 局域网的特点和优点

​	*局域网最主要的特点是：网络作为一个单位所拥有，且地理范围和站点数量均有限。*

​	局域网具有如下的一些主要优点：

+ 具有==广播功能==，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。
+ 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。
+ 提高了系统的可靠性、可用性和生存性。

*（广域网肯定就不广播了，不然要是大家都广播，带宽就被占满了。不过也有黑客用DOS或者DDOS强行占满攻击目标的带宽，使攻击目标网络瘫痪或者无法正常处理请求。）*

#### 3.7.3 局域网通信媒体

1. 静态划分通道（物理层）

   *（如果不借助设备而是网管协商并设置不现实，因为繁琐，且经常需要变动。所以局域网的网线一般用不到以下技术）*

   + 频分复用-FDM
   + 时分复用-TDM
   + 波分复用-WDM
   + 码分复用-CDMA

2. 动态媒体接入控制（多点接入）
   + **随机接入**（主要被以太网采用）*（不需要手动配置一堆东西）*
   + 受控接入，如多点线路探寻（polling）或轮询。（目前已不再被采用）

#### 3.7.4 早期以太网

​	最初的以太网是将多计算机都连接到一根总线上。当初认为这样的连接方式既简单又可靠，因为总线上没有源器件。

<small>*（连接总线的主机通信时占用整个线路，单通道，不存在使用信道复用技术）*</small>

​	比如总线上连接A、B、C、D四台主机，某一时刻A->B发送数据，此时总线上的每一个工作的计算机（除A自己）都能检测到A发送的数据信号。由于只有计算机B的地址与数据帧首部写入的地址一致，因此只有B接收这个数据帧。

<small>*（其他的主机其实也接收到数据帧了，不过判断目的地址与自己不同，就丢弃了。所以如果在这里强行抓包，是可以获取到数据的-->存在数据泄露的安全问题）*</small>

​	**具有广播特性的总线上实现了一对一的通信**。

<small>*（其实就是，不管谁发数据，总线上都广播该数据，霸占整个线路。早期这种）*</small>

### 3.8 载波监听多点接入/碰撞检测--以太网使用CSMA/CD协议

> [现代的以太网适配器还实现CSMA/CD协议吗？](https://www.zhihu.com/question/26701425?sort=created)
>
> <small>10BASE-T、100BASE-TX 和 1000BASE-T 双绞线以太网依然适用 CSMA/CD，不过 100BASE-TX 及以上非全交换网络的可靠性几乎是 0，一般以全交换形式组网用不到 CSMA/CD 罢了。10GBASE-T及以上，以及光纤以太网均不适用 CSMA/CD。</small>
>
> <small>若在1000Mbps网络中，直接是采用全双工的机制，而不好采用CSMA/CD的机制，在协议这一块就对1000Mbps以上的网络其CSMA/CD的机制就没有支持好。主要原因是，在1000Mbps的网络中，不好定义网络的最小时隙，从而节点无法很好的完成信道捕获的工作(比如交换机需要时间清理缓存，腾出空间接收数据帧之类的)。</small>
>
> [对于早已抛弃CSMA/CD的千兆以太网，甚至万兆以太网，以太网最小帧还有什么意义？](https://www.zhihu.com/question/372079821)
>
> **1000Mbps半双工还是采用CSMA/CD（即还能用集线器Hub），1000Mbps全双工模式则抛弃CSMA/CD。**
>
> **而万兆彻底抛弃CSMA/CD，只能全双工，只能用交换机switch，不可能有集线器Hub。**

 	CSMA/CD（Carrier Sence Multiple Access with Collision Detection）。

+ **"多点接入"表示许多计算机以多点接入的方式连接在一根总线上。**

+ **"载波监听"是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免碰撞。**

+ **"碰撞检测"就是用电子技术检测总线上有没有其他计算机发送的数据信号。**

<small>*（前面点到点通信用的PPP协议，这里局域网广播则用CSMA/CD协议。）*</small>

<small>*（前面物理层的香农公式可知，要是数据碰撞了，可理解为发送中的数据遭到了噪音，那么对数据最后的转换会造成干扰。在单信道传输情况下，总线广播必须避免碰撞，碰撞上了谁的数据也别指望能被识别成功。）*</small>

#### 3.8.1 碰撞检测

​	**"碰撞检测"即计算机边发数据边检测信道上的信号电压大小。**

+ 当几个站同时在总线上发送数据时，总线上的信号摆动肢将会增大（互相叠加）。
+ 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了**碰撞**。
+ 所谓"碰撞"就是发生了冲突。因此<u>"碰撞检测"也被称为"冲突检测"</u>。

​	**检测到碰撞后**

+ <u>在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。</u>
+ <u>每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。</u>

*<small>（这里说遇到碰撞后随机事件后再次发送，其实也不完全算随机，有一定的计算公式，后面会提及具体算法。**二进制指数退避算法**）</small>*

> [二进制指数退避算法--百度百科]([https://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8C%87%E6%95%B0%E9%80%80%E9%81%BF%E7%AE%97%E6%B3%95/3405081?fr=aladdin](https://baike.baidu.com/item/二进制指数退避算法/3405081?fr=aladdin))

####  3.8.2 CSMA/CD重要特性

​	使用CSMA/CD协议的以太网**不能进行全双工通信**，只能进行双向交替通信（**半双工通信**）。

​	<small>*（因为通信占用整个信道，且广播发送。）*</small>

​	<small>每个站在发送数据之后的一小段时间内，存在遭遇碰撞的可能性。这种发送的不确定性使得整个以太网的平均通信量远小于以太网的最高数据率。</small>

#### 3.8.3 争用期和最短有效帧长

​	**最先发送数据帧的站点，在发送数据帧后至多经过`2τ`（`传播时延*2`）就可以知道发送的数据帧是否遭到了碰撞**。

+ 以太网的争用期
  + 以太网的端到端往返时延`2τ`称为**争用期**（碰撞窗口）。通常取**51.2μs**作为争用期的长度。
  + 对于10Mb/s以太网，争用期内可发送512bit，即64字节。
  + **以太网在发送数据时，若前64字节未发生冲突，则后续的数据就不会发生冲突**。

+ 最短有效帧长

  + 如果发生冲突，就一定是在发送前64字节之内。
  + 由于一检测到冲突就立即中止发送，<u>这时已经发送出去的数据一定小于64字节</u>。

  + 以太网规定了最短有效帧长为64字节，凡长度小于64字节的帧都是由于冲突而异常中止的无效帧。

> 应该有不少好奇宝宝想知道这个**51.2μs**到底怎么计算来的
>
> [在传统以太网中,为什么要有最小帧长度和最大帧长度的限制?](https://www.cnblogs.com/yhl1234/archive/2009/02/03/1192085.html)
>
> [为什么最小帧长度是64字节](http://blog.sina.com.cn/s/blog_7d84d0d20101216d.html)
>
> [搞懂CSMA/CD，你就明白为什么以太网最小帧是64字节。](http://blog.sina.com.cn/s/blog_6bc2727c0102w9mi.html)
>
> [为什么以太网把争用期定为51.2us?](https://zhidao.baidu.com/question/526084236219275325.html)
>
> [对于早已抛弃CSMA/CD的千兆以太网，甚至万兆以太网，以太网最小帧还有什么意义？](https://www.zhihu.com/question/372079821)

#### 3.8.4 ==二进制指数类型退避算法==

​	发生碰撞的站点在停止发送数据后，要推迟（退避）一个随机时间，然后再重新发送数据。

+ 确定**基本退避时间**，一般是取为争用期**`2τ`**

+ 定义参数`k`
  $$
  k = Min[重传次数，10]
  $$
  
+ 从整数集合\[0，1，......，（2<sup>k</sup>-1）\]中随机取一个数，记为`г`。**重传所需的时延就是`г`倍的基本退避时间**。

+ 当**重传达到16次仍不能成功时，即丢弃该帧**，并向高层报告。

*(无需用户参与，二进制指数避让算法由CSMA/CD协议实现，也就是我们直接使用具体的设备就好了。)*

> [二进制指数退避算法--百度百科]([https://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8C%87%E6%95%B0%E9%80%80%E9%81%BF%E7%AE%97%E6%B3%95/3405081?fr=aladdin](https://baike.baidu.com/item/二进制指数退避算法/3405081?fr=aladdin))

### 3.9 以太网

#### 3.9.1 以太网的两个标准

> [以太网标准--百度百科]([https://baike.baidu.com/item/%E4%BB%A5%E5%A4%AA%E7%BD%91%E6%A0%87%E5%87%86/21570982?fr=aladdin](https://baike.baidu.com/item/以太网标准/21570982?fr=aladdin))
>
> 为了使网络系统中的软硬件设备不受生产厂家和型号等不同的限制，制定了各种各样的标准来保证他们之间的相互通，以太网标准就是其中之一。
>
> 以太网标准即以太网规定的包括物理层的连线、电信号和介质访问层协议的内容。

+ DIX Ethernet V2是世界上第一个局域网产品（以太网）的规约。

+ IEEE的802.3标准

  <small>DIX Ethernet V2标准与IEEE的802.3标准只有很小的差别，因此可以将802.3局域网简称为“以太网”。严格来说，"以太网"应当是指符合DIX Ethernet V2 标准的局域网。</small>

#### 3.9.2 以太网与数据链路层的两个子层

​	为了让数据链路层能更好地适应多种局域网标准呢，802委员会局域网的数据链路层拆分成两个子层：

+ 逻辑链路控制LLC（Logical Link Control）子层<small>*（基本弃用了，有些设备压根就不带这个了）*</small>
+ **媒体接入控制==MAC==（Medium Access Control）子层**

​	*与接入到传输媒体有关的内容基本都放在MAC子层，而LLC子层则与传输媒体无关，不管采用何种协议的局域网对LLC子层来说都是透明的。*

​	*由于TCP/IP体系经常使用的局域网是DIX Ethernet V2而不是802.3标准中的几种局域网，因此现在802委员会制定的逻辑链路控制子层LLC（即802.2标准）的作用已经不大了。*

​	*<u>很多厂商生产的适配器上就仅装有MAC协议而没有LLC协议。</u>*	

#### 3.9.3 以太网提供的服务

*以太网提供的服务是不可靠的交付，即尽最大努力的交付。*

*当接收站受到有差错的数据帧时就丢弃此帧，其他什么也不做。差错纠正由高层来决定。*

*如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送。*

概述如下：

+ 服务不可靠
+ 差错帧丢弃，纠错由高层实现
+ 重传数据帧和普通数据帧格式相同

> 实际上，数据链路层也存在支持差错重传的协议，比如ARQ
>
> [ARQ--百度百科](https://baike.baidu.com/item/ARQ/7402812?fr=aladdin)
>
> + 停等式ARQ	
> + 回退n帧的ARQ
> + 选择性重传ARQ
> + 混合ARQ
>
> **在现代的无线通信中，ARQ主要应用在无线链路层**。比如，在WCDMA和cdma2000无线通信中都采用了选择性重传ARQ和混合ARQ。
>
> 优点：比较简单 。因而被广泛的应用在[分组交换](https://baike.baidu.com/item/分组交换)网络中。
>
> 缺点：1.通信信道的利用率不高，也就是说，信道还远远没有被数据比特填满。2.是需要接收方发送ACK，这样增加了网络的负担也影响了传输速度。重复发送[数据包](https://baike.baidu.com/item/数据包)来纠正错误的方法也严重的影响了它的传输速度。

#### 3.9.4 利用集线器Hub组成以太网

​	*传统（早期）以太网最初是使用粗同轴电缆，后来演变到使用便宜的同轴电缆。再后来发展为使用更便宜和更灵活的双绞线。不用电缆而使用无屏蔽双绞线。*

​	*每个站需要采用两队双绞线，分别用于发送和接收。*

​	*这种以太网采用星形拓扑，在星形的中心则添加一种可靠性非常高的设备叫作集线器（Hub）*

使用集线器Hub<small>（物理层设备）</small>组织的以太网，就是一个冲突域。*（现在这种方式基本弃用了）*

#### 3.9.5 集线器的Hub一些特点

​	集线器是使用电子器件来<u>模拟实际电缆线</u>的工作，因此整个系统仍然像一个传统的以太网那样运行。*集线器使用了大规模集成电路芯片，因此这样的硬件设备的可靠性已大大提高了。*

​	**使用集线器的以太网在逻辑上仍然是一个总线网，各工作站使用的还是CSMA/CD协议，并共享逻辑上的总线**。

​	集线器很像一个多接口的转发器，工作在物理层。

*（集线器Hub没啥智商，受到流进某一接口的数据，就直接往集线器的其他Hub接口广播发送）*

#### 3.9.6 常见以太网标准(网线)

> [以太网标准--百度百科]([https://baike.baidu.com/item/%E4%BB%A5%E5%A4%AA%E7%BD%91%E6%A0%87%E5%87%86/21570982?fr=aladdin#3](https://baike.baidu.com/item/以太网标准/21570982?fr=aladdin#3))

**10BASE-T**的通信距离稍短，每个站到集线器的距离不超过**100m**，这种`10Mb/s`速率的无屏蔽双绞线星形网的出现，既降低了成本，又提高了可靠性。

**10BASE-T**双绞线以太网的出现，是局域网发展史上一个非常重要的里程碑，它为以太网在局域网中的统治地位奠定了牢固的基础。

#### 3.9.7 以太网的信道利用率

​	以太网的信道被占用的情况：

​	争用期长度为`2τ`，即端到端传播时延的两倍。检测到碰撞后不发送干扰信号。

​	帧长为L（bit），数据发送速率为C（b/s），因此帧的发送时间为L/C = T<sub>0</sub>（s）。

​	**一个帧从开始发送，经可能发生的碰撞后，将再重传数次，到<u>发送成功且信道转为空闲</u>（即再经过时间`τ`使得信道上无信号在传播）时为止，是==发送一帧==所需的平均时间。**

``` none
|--------------- 发生碰撞 ---------------|++++++++ 占用期 ++++++++|
| 争用期 | 争用期 | 争用期...争用期 | 争用期| ......发送成功........  |
|  2τ   |  2τ   |  2τ  ...  2τ  |  2τ  | \\\\\\T0\\\\\\\\\\\  τ |
```

> 回顾之前网络概述，提到过计算机网络的时延，包括4部分：发送时延、传播时延、处理时延、排队时延。
>
> [发送时延--百度百科]([https://baike.baidu.com/item/%E5%8F%91%E9%80%81%E6%97%B6%E5%BB%B6/10411985?fr=aladdin](https://baike.baidu.com/item/发送时延/10411985?fr=aladdin))

#### 3.9.8 以太网的信道利用率：参数а

​	要提高以太网的通信利用率，就必须减小`τ`<small>（传播时延）</small>与`T0`<small>(发送时延)</small>之比。在以太网中定义了参数`а`，它是以太网单程端到端时延`τ`与帧的发送时间`T0`之比：
$$
а=\frac{τ}{T_0}
$$

+ `a`—>0表示一发生碰撞就可以立即检测出来，并立即停止发送，因而信道利用率很高。
+ `a`越大，表明争用期所占比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低。 

**对以太网参数的要求**

+ 当数据率一定时，以太网的连线的长度受到限制，否则`τ`的数值会太大。
+ 以太网的帧长不能太短，否则`T0`的值会太小，使`a`值太大。

**信道利用率的最大值**

+ 在理想化的情况下，以太网上的各站发送数据都不会产生碰撞（这显然已经不是CSMA/CD，而是需要使用一种特殊的调度方法），即总线一旦空闲就有某一站立即发送数据。

+ 发送一帧占用线路的时间是`T0+τ`<small>(也就是前面提到的发送成功且线路恢复空闲的所需时间)</small>，而帧本身的发送时间是`T0`。于是我们可以计算出**理想情况下的极限信道利用率S<sub>max</sub>为**：
  $$
  Smax =\frac{T_0}{T_0+τ}=\frac{1}{1+a}
  $$

### 3.10 MAC

#### 3.10.1 MAC层的硬件地址(MAC地址)

<small>前面3.9.2介绍过，以太网802委员会将数据链路层拆分成两层逻辑链路控制子层LLC和媒体接入控制子层MAC。前者LLC现在基本弃用了。</small>

​	在局域网中，**硬件地址**又被称为**物理地址**，或**MAC地址**。

​	<u>802标准所说的"地址"严格地讲应当是每一站的”名字“或标识符。</u>

​	但鉴于大家都早已习惯了将这种48位的”名字“称为”地址“，所以这里也直接这么说，虽然这种说法不严谨。

+ IEEE的注册管理机构RA负责向厂家分配地址字段的前三个字节（即高位24位）。
+ 地址字段中的后三个字节（即低位24位）由厂家自行指派，称为<u>扩展标识符</u>，必须保证生产出的适配器没有重复地址。
+ 一个地址块可以生成2<sup>24</sup>个不同的地址。这种**48位**地址称为MAC-48，它的通用名称是`EUI-48`。
+ **"MAC地址"实际上就是适配器地址或适配器标识符`EUI-48`**。

*（厂家标识符24bit | 商品编码24bit）大概这个样子。MAC在硬件出厂前就设置在硬件内了。*

​	*<small>网卡芯片的MAC出厂固定不能修改，但我们可以制定计算机用我们自定义的MAC地址通讯，而不用网卡自带的MAC地址。</small>*

​	*<small>win10通过CMD输入`ifconfig /all`可以查看MAC地址</small>*

​	*<small>有些对网络用户鉴权较严格的网络，会通过MAC等手段验证连接网络的用户的身份。（比如某些校园网，只有在学校系统注册过身份的MAC地址能够连通校园网。）</small>*

​	*<small>接入同一台交换机switch的两个设备要是拥有相同MAC，则两者皆无法连通网络。</small>*

#### 3.10.2 适配器检查MAC地址

​	适配器从网络上每收到一个**MAC帧**就首先用硬件检查MAC帧中的MAC地址。

+ 如果是发往本站的帧则收下，然后再进行其他的处理。
+ 否则就将此帧丢弃，不再进行其他的处理。

​	"发往本站的帧"包括以下三种帧：

+ 单播（unicast）帧（一对一）
+ 广播（broadcast）帧（一堆全体）
+ 多播（multicast）帧（一对多）

#### 3.10.3 MAC帧格式

​	常用的以太网MAC帧格式有两种标准：

+ **DIX Ethernet V2标准**
+ **IEEE 的 802.3 标准**

​	**==最常用的MAC帧是以太网V2的格式==**。

![img](https://bkimg.cdn.bcebos.com/pic/3b87e950352ac65c18921eccf0f2b21192138afd?x-bce-process=image/watermark,g_7,image_d2F0ZXIvYmFpa2U4MA==,xp_5,yp_5)

+ 数据字段的正式名称是MAC客户数据字段<small>（可封装IP数据报）</small>，最小长度64字节-18字节的首部和尾部=数据字段的最小长度（46字节）。当数据字段的长度小于46字节时，应在数据字段的后面加入整数字节的填充字段，以保证以太网的MAC帧不小于64字节。
+ FCS字段4字节。*当传输媒体的误码率为1\*10<sup>-8</sup>时，MAC子层可使未检测到的差错小于1\*10<sup>-14</sup>*
+ **在帧的前面插入的8字节中第一个字段共7个字节，是前同步码，用来迅速实现MAC帧的比特同步。第二个字段就是帧开始定界符，表示后面的信息就是MAC帧**。

<u>由于**以太网使用曼彻斯特编码**（物理层、数字信号），其表示0和1时都有电平跳变，所以能够区分数据0和停止传输数据这两种情况。再加上**以太网**传输数据时有"帧间最小间隔"的限制，所以以太网传输MAC帧只需要告知帧开始定界符，而没必要告知帧结束定界符。</u>

> [mac帧--百度百科]([https://baike.baidu.com/item/mac%E5%B8%A7/6156345?fr=aladdin](https://baike.baidu.com/item/mac帧/6156345?fr=aladdin))
>
> [短帧间间隔--百度百科]([https://baike.baidu.com/item/%E7%9F%AD%E5%B8%A7%E9%97%B4%E9%97%B4%E9%9A%94/22307951?fr=aladdin](https://baike.baidu.com/item/短帧间间隔/22307951?fr=aladdin))
>
> [曼彻斯特编码--百度百科]([https://baike.baidu.com/item/%E6%9B%BC%E5%BD%BB%E6%96%AF%E7%89%B9%E7%BC%96%E7%A0%81/8902319?fr=aladdin](https://baike.baidu.com/item/曼彻斯特编码/8902319?fr=aladdin))
>
> [以太网MAC帧格式](https://blog.csdn.net/hhpingyear/article/details/80216680)
>
> [以太网中的MAC帧没有帧定界符，为什么点对点通信中的PPP帧需要帧定界符？](https://zhidao.baidu.com/question/168429599.html)
>
> [ppp协议有字节表示数据的开头和结尾Mac帧为什么没有？](https://www.zhihu.com/question/55734189)
>
> **PPP帧一般工作在因特网，而MAC帧工作在以太网**。在使用CSMA/CD机制的以太网（一般1000Mbps及以上的以太网络，CSMA/CD支持不好，因为不好定义帧间最小间隔），由于以太网使用曼彻斯特编码，可以辨别无信号和信号0，再加上以太网规定了短帧间间隔，即可以直接根据是否还有接受到数据直接判断MAC的数据帧结束，所以没必要再添加帧尾定界符。
>
> [MAC真向下传到物理层时为什么要加上同步码？？ ](https://zhidao.baidu.com/question/24095641.html)
>
> （个人理解是就是，帧头定界符前面加上同步码，方便数据接受方设备即时进入处理数据的状态。打个比方，交换机A突然收到某处发来的没有同步码的数据帧，内部临时进行操作，然后才能开始处理发过来的数据帧，这时候都可能已经丢失几个bit了。那如果加了同步码（7bit），等于还有前7位时可以进入正式处理接收数据的状态。）
>
> [同步传输--百度百科]([https://baike.baidu.com/item/%E5%90%8C%E6%AD%A5%E4%BC%A0%E8%BE%93/2007281?fr=aladdin](https://baike.baidu.com/item/同步传输/2007281?fr=aladdin))
>
> [请教关于PPP帧MAC帧和HDLC帧的问题 ](http://www.txrjy.com/asktech/question.php?qid=2180)
>
> [PPP帧格式 与 MAC帧格式的区别](https://www.eefocus.com/lubee/blog/10-10/197201_5fa0a.html)
>
> [网络的数据链路层什么时候将数据封装成PPP帧什么时候封装成MAC帧？](https://zhidao.baidu.com/question/101677997.html)
>
> 当同步或者异步线路使用[PPP协议](https://www.baidu.com/s?wd=PPP协议&tn=SE_PcZhidaonwhc_ngpagmjz&rsv_dl=gh_pc_zhidao)封装的时候，需要PPP帧格式通过LCP ,身份验证，NCP等建立会话链路。
>
> 因为PPP帧是bai属于PPP协议范围内，而duPPP协议是广域网协议，所以在广域网中zhi发送数据dao时，可能将数据封装成PPP帧。
> 而MAC帧是以太网帧，以太网是局域网，所以在以太网中发送数据时，可能将数据封装成MAC帧。

#### 3.10.4 无效的MAC帧

+ 真的长度不是整数个字节
+ 用收到的帧检验序列FCS查出有差错
+ 数据字段的长度不在46-1500字节之间。

有效的MAC帧长度为64-1518字节之间。对于检查出的无效MAC帧就简单地丢弃，以太网不负责重传丢失的帧。

#### 3.10.5 帧间最小间隔

​	**帧间最小间隔为9.6μs，相当于96bit的发送时间**。

​	一个站在检测到总线开始空闲后，还要等待9.6μs才能再次发送个数据。

​	这样做时**为了使刚刚接受到数据帧的站的数据缓存来得及清理，做好接收下一帧的准备**。

### 3.11 物理层、数据链路层的网络设备(组网)考虑

#### 3.11.1 在物理层考虑扩展

用集线器扩展局域网优点

+ 使原来属于不同碰撞域的局域网上的计算机能够进行跨碰撞域的通信。
+ 扩大了局域网覆盖的地理范围。

用集线器扩展局域网的缺点

+ **碰撞域增大了，但总的吞吐量并未提高。** *<small>（毕竟广播数据，占用总线）</small>*

+ 如果不同的碰撞域使用不同的数据率，那么就不能用集线器将他们互连起来。

#### 3.11.2 在数据链路层考虑扩展

> [网桥--百度百科]([https://baike.baidu.com/item/%E7%BD%91%E6%A1%A5/99310?fr=aladdin](https://baike.baidu.com/item/网桥/99310?fr=aladdin))
>
> [如何通俗地解释什么是网桥？](https://www.zhihu.com/question/67473683)

在数据链路层扩展局域网是使用**网桥**。

**网桥工作在数据链路层，它根据MAC帧的目的地址对收到的帧进行转发。网桥具有过滤帧的功能。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的MAC地址，然后再确认将该帧转发到哪一个接口。**

#### 3.11.3 使用网桥扩展以太网：好与坏

好：

+ 过滤通信量。*（如果MAC-端口表显示在获取数据的这个端口就存在目的地址，那么就不用再广播到其他接口。）*
+ 扩大了物理范围。*（毕竟是集线器Hub的升级版）*
+ 提高了可靠性。*（网桥有缓存再转发的功能，但是缓存再转发也意味着更加耗时）*
+ **可互连不同物理层、不同MAC子层和不同速率（如10Mb/s和100Mb/s以太网）的局域网**。*（传统集线器就做不到）*

坏：

+ 存储转发增加了时延*（补充，查MAC-端口表后，其实转发到另一个端口也还是广播另一头的整个总线）*
+ <u>在MAC子层并没有流量控制功能</u>。*（MAC子层主要就传输数据，前面提到的基本弃用了的LLC子层就能提供一些类似流控制的功能）*
+ 具有不同MAC子层的网段桥接在一起时时延更大。*（毕竟网桥还是广播转发的数据）*
+ <u>网桥只适合用户数不太多（不超过几百个）和通信量不太大的局域网，否则有时还会因传播过多的**广播信息**而产生网络拥塞。这就是所谓的**广播风暴**</u>。

> [广播风暴--百度百科]([https://baike.baidu.com/item/%E5%B9%BF%E6%92%AD%E9%A3%8E%E6%9A%B4/3574878?fr=aladdin](https://baike.baidu.com/item/广播风暴/3574878?fr=aladdin))
>
> 广播风暴（broadcast storm）简单的讲是指当广播数据充斥网络无法处理，并占用大量[网络带宽](https://baike.baidu.com/item/网络带宽/6120475)，导致正常业务不能运行，甚至彻底瘫痪，这就发生了“广播风暴”。一个[数据帧](https://baike.baidu.com/item/数据帧/10571824)或包被传输到本地[网段](https://baike.baidu.com/item/网段/11026985) （由[广播域](https://baike.baidu.com/item/广播域/5293530)定义）上的每个[节点](https://baike.baidu.com/item/节点/865052)就是广播；由于[网络拓扑](https://baike.baidu.com/item/网络拓扑/4804125)的设计和连接问题，或其他原因导致广播在网段内大量复制，传播[数据帧](https://baike.baidu.com/item/数据帧/10571824)，导致网络性能下降，甚至[网络瘫痪](https://baike.baidu.com/item/网络瘫痪/5928979)，这就是广播风暴。

#### 3.11.4 透明网桥

目前使用得最多的网桥就是**透明网桥**（transparent bridge）

"透明"是指局域网上的站点并不知道所发送的帧将经过哪几个网桥，因为网桥对各站来说是看不见的。*（反正网桥会学习MAC-端口表，用户无需参与学习过程。）*

透明网桥是一种**即插即用设备**，其标准是IEEE 802.1D。

> [透明网桥--百度百科]([https://baike.baidu.com/item/%E9%80%8F%E6%98%8E%E7%BD%91%E6%A1%A5](https://baike.baidu.com/item/透明网桥))
>
> <small>透明网桥(transparent bridge)的标准是802.1D。支持这种设计的人首要关心的是完全透明。按照他们的观点，装有多个[LAN](https://baike.baidu.com/item/LAN)的单位在买回IEEE标准网桥之后，只需把连接插头插入网桥，就万事大吉。透明网桥是一种[即插即用](https://baike.baidu.com/item/即插即用/627180)设备，只要把网桥接入[局域网](https://baike.baidu.com/item/局域网/98626)，不需要改动硬件和软件，无需设置地址开关，无需装入[路由表](https://baike.baidu.com/item/路由表/2707408)或参数，网桥就能工作。</small>
>
> + 自学习和转发帧
> + 逆向学习算法
> + 生成树算法STP（Spanning Tree Protocol）*(避免环路导致的广播风暴)*
> + 透明网桥的路径选择算法归纳
> + 优缺点

#### 3.11.5 透明网桥的自学习算法

​	按照以下**自学习算法**处理收到的帧和建立转发表。

+ 若从A发出的帧从接口x进入了某网桥，那么从这个接口出发沿相反方向一定可以把一个帧传送到A。
+ 网桥每收到一个帧，就记下其<u>源地址</u>和进入网桥的<u>接口</u>，作为转发表中的一个项目。
+ 在建立转发表时把帧首部中的源地址写在"地址"这一栏的下面。
+ 在转发帧时，则是根据收到的帧首部中的目的地址来转发的。这时就把"地址"栏下面已经记下的源地址当作目的地址，而把记下的地址直接当作转发接口。

​	网桥在转发表中登记了以下三个信息

+ 地址
+ 接口
+ **帧进入网桥的时间**

​	这是因为以太网的拓扑可能经常会发生变化，站点也可能会更换适配器（这就改变了站点的地址）。另外，以太网上的工作站并非总是接通电源的。

​	**把每个帧到达网桥的时间登记下来，就可以在转发表中只保留网络拓扑的最新状态信息**。这样就使得网桥中的转发表能反应当前网络的最新拓扑状态。*<small>黑客可以利用这点搞ARP欺骗等，导致网络产生广播风暴，谁也别想上网。</small>*

#### 3.11.6 透明网桥的自学习和帧转发-小结

​	网桥收到一帧后先进行**自学习**。查找转发表中与收到帧的<u>源地址</u>有无相匹配的项目。如没有，就在转发表中增加一个项目（源地址、进入的接口和时间）。如有，则把原有的项目进行更新。

​	**转发帧**。查找转发表中与收到帧的<u>目的地址</u>有无相匹配的项目。

+ 如没有，则通过**所有其他接口**（但进入网桥的接口除外）转发。*（接口广播）*

+ 如有，则按转发表中给出的接口进行转发。*（如果那个接口连接多个主机，那这多个主机都能收到广播）*

+ 若转发表中给出的接口就是该帧进入网桥的接口，则应**丢弃**这个帧（因为这时不需要经过网桥进行转发）。

#### 3.11.7 透明网桥的生成树算法STP

​	互联在一起的网桥在进行彼此通信后，就能找出原来的网络拓扑的一个子集。在这个子集里，整个连通的网络中不存在回路，即在任何两站之间只有一条路径。

​	为了避免产生的转发的帧在网络中不断地兜圈子。*（广播风暴）*

​	<u>为了得出能够反应网络拓扑发生变化时的生成树，在生成树上的根网桥每隔一段时间还要对生成树的拓扑进行更新</u>。

> [快速生成树--百度百科]([https://baike.baidu.com/item/%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90%E6%A0%91](https://baike.baidu.com/item/快速生成树))
>
> [生成树协议--百度百科]([https://baike.baidu.com/item/%E7%94%9F%E6%88%90%E6%A0%91%E5%8D%8F%E8%AE%AE](https://baike.baidu.com/item/生成树协议))
>
> <small>STP的工作过程如下：首先进行根网桥的选举，其依据是网桥优先级（bridge priority）和MAC地址组合生成的桥ID，桥ID最小的网桥将成为网络中的根桥（bridge root）。在此基础上，计算每个节点到根桥的距离，并由这些路径得到各冗余链路的代价，选择最小的成为通信路径（相应的端口状态变为forwarding），其它的就成为备份路径(相应的端口状态变为blocking)。STP生成过程中的通信任务由BPDU完成，这种数据包又分为包含配置信息的配置BPDU（其大小不超过35B）和包含拓扑变化信息的通知BPDU（其长度不超过4B）。</small>
>
> [STP （生成树协议）--百度百科](https://baike.baidu.com/item/STP/2813395)
>
> [详细讲述STP过程](https://wenku.baidu.com/view/6f75ddb987c24028905fc376.html)

### 3.12 多接口网桥：交换机switch

> [交换机--百度百科]([https://baike.baidu.com/item/%E4%BA%A4%E6%8D%A2%E6%9C%BA/103532?fr=aladdin](https://baike.baidu.com/item/交换机/103532?fr=aladdin))
>
> [网桥和交换机有什么区别？](https://zhidao.baidu.com/question/65634069.html?qbl=relate_question_0&word=%CD%F8%C7%C5%CA%C7%C8%AB%CB%AB%B9%A4%CD%A8%D0%C5%C2%F0)
>
> [三层交换机和路由器的区别](https://www.cnblogs.com/josie-xu/p/10477177.html)

​	1990年问世的<u>交换式集线器</u>（switch hub），可明显地提高局域网的性能。

​	交换式集线器常被称为**以太网交换机**（switch）或**第二层交换机**（表明此交换机工作在数据链路层）。

​	以太网交换机通常都有十几个接口。因此，以太网交换机**实质上就是一个多接口的网桥**，可见交换机工作在数据链路层。

​	交换机特点：

+ 以太网交换机的每个接口都直接与主机相连，并且一般都工作在**全双工方式**。*（网桥）*
+ 交换机能同时连通许多对的接口，使每一对相互通信的主机都能像独占通信媒体那样，进行无碰撞地传输数据。*（每根连接交换机的网线拥有自己的独享带宽）*
+ 以太网交换机由于使用了专用的交换结构芯片，其交换速率就比较高。

### 3.13 虚拟局域网VLAN

#### 3.13.1 VLAN

> [网段--百度百科]([https://baike.baidu.com/item/%E7%BD%91%E6%AE%B5](https://baike.baidu.com/item/网段))
>
> 网段（network segment）一般指一个计算机网络中使用同一物理层设备（传输介质，中继器，集线器等）能够直接通讯的那一部分。
>
> [虚拟局域网--百度百科]([https://baike.baidu.com/item/%E8%99%9A%E6%8B%9F%E5%B1%80%E5%9F%9F%E7%BD%91?fromtitle=VLAN&fromid=320429](https://baike.baidu.com/item/虚拟局域网?fromtitle=VLAN&fromid=320429))
>
> 在计算机网络中，一个二层网络可以被划分为多个不同的广播域，一个广播域对应了一个特定的用户组，默认情况下这些不同的广播域是相互隔离的。不同的广播域之间想要通信，需要通过一个或多个路由器。这样的一个广播域就称为VLAN。

​	交换机switch的使用使得VLAN的创建称为可能。*（言外之意就是有了交换机后才有VLAN的概念）*

​	**虚拟局域网VLAN是由一些局域网网段构成的与物理位置无关的逻辑组**。

+ 这些网段具有某些共同的需求。
+ **每一个VLAN的帧都有一个明确的标识符，指明发送这个帧的工作站是属于哪一个VLAN**。

虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。

**一个VLAN=一个广播域=逻辑网段（子网）**

*（交换机switch可以设置接口对应的VLAN，比如某交换机共24个接口，默认24个接口共同在一个默认的VLAN。如果我们手动修改，配置成后12个接口在新建的VLAN2里，那么连接前12接口的设备无法通过该交换机直接与后12接口的设备进行通讯。）*

> [如何实现交换机不同VLAN、不同网段之间互访？](https://baijiahao.baidu.com/s?id=1627869451704710992&wfr=spider&for=pc)
>
> 通过VLAN能够有效的降低局域网的广播包，提升局域网的网络性能；划分VLAN需要通过支持命令行的二层交换机，普通交换机无法实现VLAN划分。
>
> **实现不同VLAN之间的访问，有两种方式：一种是通过三层交换机，通过默认网关的方式实现不同VLAN之间的访问；一种是通过路由器，利用路由器的子端口和默认路由的方式实现访问。**

#### 3.13.2 跨交换机的VLAN

​	在两个交换机switch-A、switch-B上都划分前一半端口属于VLAN1，后一半端口属于VLAN2。将财务部4台计算机PC-a~d平均分配到switch-A、switch-B的VLAN1接口上，然后将销售部的4台计算机PC-e~h平均分配到switch-A、switch-B的VLAN2接口上。为了确保两个交换机上的VLAN1能够直接通信，可以使用一根网线将switch-A、switch-B前半部分属于VLAN1的接口相连，同理用一个网线把switch-A、switch-B的后半部分属于VLAN2的接口相连。这样财务部的计算机PC-a、b、c、d就属于同一逻辑网段了，而销售部同理PC-e、f、g、h属于同一个逻辑网段。

​	按照上面的方法，如果有10个VLAN跨这两个交换机switch-A、switch-B，每一个VLAN使用一根网线连接两个交换机，这也太浪费交换机端口和网线了。而更好的方法就是，使用**干道链路**。

交换机的端口有两种类型：

1. **访问端口**：访问端口只能属于某一个VLAN，它只能承载某一个VLAN的流量，连接访问端口的链路称为访问链路。
2. **中继端口**：中继端口能够同时承载多个VLAN的流量，**连接中继端口的链路称为干道链路**。**数据帧进入干道链路时需要添加帧标记（或称VLAN ID），离开干道链路时去掉帧标记**，这个过程对计算机来说是透明的。

干道链路采用**统计时分复用**（STDM），会在数据帧上标记所属的VLAN（如果网络内就只有一个VLAN就不会标记），然后通过干道链路访问另一个交换机switch的同一个VLAN区域。

**交换机组件的网络，如果需要多个VLAN通过的链路就需要配置为干道链路。如果链路上只需要单一VLAN的数据通过就可以配置为访问链路。** *（言外之意就是交换机连接交换机，不一定就是干道链路，因为接入层的交换机虽然接入汇聚层的交换机，但是其switch没有进行VLAN的划分，即属于一整个默认的VLAN。而假如另外三个接入层交换机各通过一条线接入汇聚层的交换机，且这三个交换机switch都平均分配自己的端口到VLAN1、VLAN2、VLAN3，那么他们接入汇聚层交换机的三条链路都是干道链路，需要通过统计时分复用来共用带宽。）*

> [干道技术--百度百科]([https://baike.baidu.com/item/%E5%B9%B2%E9%81%93%E6%8A%80%E6%9C%AF/11066073?fr=aladdin](https://baike.baidu.com/item/干道技术/11066073?fr=aladdin))
>
> 实际上，无论划分了多少个VLAN，都可以通过这样一条只占用两个[交换机](https://baike.baidu.com/item/交换机)接口的干道实现各自VLAN之间的通信，而不会占用过多的交换端口，这种技术称为干道技术。

#### 3.13.3 ISL标记

> [ISL--百度百科](https://baike.baidu.com/item/ISL/931931?fr=aladdin)
>
> ISL & DISL：[思科](https://baike.baidu.com/item/思科)交换链路内协议和动态 ISL 协议（ISL & DISL：Cisco Inter-Switch Link Protocol and Dynamic ISL Protocol） 交换链路内协议（ISL），是思科私有协议，主要用于维护[交换机](https://baike.baidu.com/item/交换机/103532)和[路由器](https://baike.baidu.com/item/路由器/108294)间的通信流量等 VLAN 信息。

ISL干道使VLAN能够跨骨干。

+ 通过特定集成电路来实现
+ 不需要在客户计算机上采取配置，客户机不能够看到ISL头
+ 在交换机之间，路由器和交换机，交换机和支持ISL网卡的服务器之间配置

#### 3.13.4 虚拟局域网帧格式

​	虚拟局域网协议允许在以太网的帧格式中插入一个4字节的标识符，称为VLAN标记（tag），用来指明发送该帧的工作站属于哪一个虚拟局域网。

```none
802.3 MAC帧
[6字节=目的地址][6字节=源地址]【4字节=VLAN标记】[2字节=长度/类型][46字节~1500字节=数据][4字节=FCS]
```

### 3.14 不同规格的以太网

#### 3.14.1 100BASE-T 以太网

​	速率达到或超过100Mb/s的以太网称为**高速以太网**

​	在双绞线上传送100Mb/s基带信号的星型拓扑以太网，仍使用IEEE 802.3 的CSMA/CD协议。100BASE-T以太网又被称为**快速以太网（Fast Ethernet）**。

100Base-T以太网的物理层：

+ 100BASE-TX：使用2对UTP5类线或者屏蔽双绞线STP
+ 100BASE-FX：使用2对光纤
+ 100BASE-T4：使用4对UTP3类线或5类线。

#### 3.14.2 100Base-T特点

​	可在**全双工**方式下工作而无冲突发生。因此，不使用CSMA/CD协议。

​	MAC帧格式仍然是802.3标准规定的。

​	**保持最短帧长不变**，但将一个网段的<u>最大电缆长度减小到100m</u>。**帧间时间间隔从原来的9.6μs该为现在的0.96μs**。

*（可全双工，因为接口可缓存，有阻塞队列，所以收发不影响。）*

#### 3.14.3 吉比特以太网

​	允许在1Gb/s下**全双工和半双工**两种方式工作。

​	使用802.3协议规定的帧格式。

​	**在半双工方式下使用CSMA/CD协议**（全双工方式不需要使用CSMA/CD协议）

​	**与10BASE-T和100BASE-T技术向后兼容**。

​	**当吉比特以太网工作在全双工方式时（即通信双方可同时进行发送和接收数据），<u>不使用载波延伸和分组突发</u>**。

物理层：

1. 1000BASE-X		基于**光纤**通道的物理层：

   + 1000BASE-SX	SX表示短波长

   + 1000BASE-LX	LX表示长波长

   + 1000BASE-CX	CX表示铜线

2. 1000BASE-T

   + 使用4对5类UTP

#### 3.14.4 10吉比特以太网

​	10吉比特以太网与10Mb/s，100Mb/s和1Gb/s以太网的**帧格式完全相同**。

​	10吉比特以太网还**保留了802.3标准规定的以太网最小和最大帧长，便于升级**。*<small>（其实很多类似的，都是因为早期设定已经出了很多对应的设备和用于实际网络了，不方便改标准什么的，所以就沿用呗。）</small>*

​	**10吉比特以太网不再使用铜线而只是用光纤作为传输媒体**。

​	10吉比特以太网只工作在**全双工**方式，因为没有争用问题，也**不使用CSMA/CD协议**。

#### 3.14.5 端到端的以太网传输

​	**10吉比特以太网的出现，以太网的工作范围已经从局域网（校园网、企业网）扩大到城域网和广域网，从而实现了端到端的以太网传输**。*<small>（毕竟我大中华就是一个大局域网呗。）</small>*

这种工作方式的好处是：

+ 成熟的技术
+ 互操作性很好
+ 在广域网中使用以太网时价格便宜
+ **统一的帧格式**简化了操作和管理*（MAC帧）*

#### 3.14.6 使用高速以太网进行宽带接入

​	以太网已成功把速率提高到1~10Gb/s。所覆盖的地理范围也扩展到城域网和广域网，因此现在人们正在尝试使用以太网进行宽带接入。*<small>（也就是ISP收费啦）</small>*

​	**以太网接入的重要特点是它可提供双向的宽带通信，并且可根据用户对宽带的需求灵活地进行宽带升级**。

​	采用以太网接入可实现端到端的以太网传输，中间不需要再进行帧格式的转换。这就提高了数据的传输效率和降低了传输的成本。

*（比如很多人家里已经是光纤到户了，但是光纤只是传输介质，ISP网络提供商并没说就给你宽带套餐升级到1Gb/s，只不过用了光纤后，方便以后你升级套餐成1Gb的宽带。简言之，介质决定上限，但是具体宽带大小还是给钱越多带宽越多。）*

> [运营商对带宽进行限制的原理是怎样的？](https://www.zhihu.com/question/19811707)
>
> [深入探讨网络带宽问题](https://zhuanlan.zhihu.com/p/22875995)
>
> [运营商和带宽的那些事](https://zhuanlan.zhihu.com/p/24938843)