# 计算机网络复习

> 回顾一些计算机网络的知识要点
>
> 推荐想再深入的可以再看看《计算机网络-自顶向下方法》和《TCP/IP详解卷1：协议》，后续看情况也会整理对应的笔记。

## 0. 计算机网络概述

### 0.1 网络组成

1. 边缘部分

   + 客户服务器方式C/S
   + 对等方式P2P

2. 核心部分

   + 电路交换

     建立连接（申请占用通信资源）-> 通话（一直占用通信资源） -> 释放连接（释放通信资源）

     适合数据量很大的实时性传输，==核心路由器之间可以使用电路交换==。

     建立连接后，一次性发送所有数据。

   + 报文交换

     每个中间路由器需要重新发送整个完整的报文。

   + 分组交换

     将报文拆分成多个分组后，每个中间路由器需要重新发送整个完整的分组。由于分组更小，时延也就更小。

     （理想情况下，比如一个报文平均分4分，从起点到终点，中间需要经过2路由时，那么第一个路由收到分组1，马上接收分组2，并且把分组1发送到第二个中间路由器。）

## 1. 计算机网络体系结构

### 1.1 OSI七层模型

> [协议数据单元PDU]([https://baike.baidu.com/item/%E5%8D%8F%E8%AE%AE%E6%95%B0%E6%8D%AE%E5%8D%95%E5%85%83/8226389?fromtitle=PDU&fromid=1855#viewPageContent](https://baike.baidu.com/item/协议数据单元/8226389?fromtitle=PDU&fromid=1855#viewPageContent))

1. 物理层：电压、接口标准。位流(bit流)传输。
2. 数据链路层：数据如何封装，添加物理层地址（MAC）、碰撞检测、指数退让。数据帧传输。
   + ARP、RARP（功能上网络层，实际实现、工作是数据链路层）
3. 网络层：IP地址编址、选择最佳路径。分组传输（分组就是拆分报文，然后添加一些首部信息，这样获得所有分组后，可以按照顺序组合回成更高层的报文）
   + IP、ICMP
4. 传输层：可靠传输TCP（需建立会话）、不可靠传输UDP、流量控制。报文传输。
   + TCP、UDP
5. 会话层：服务和用户建立的绘画(ps:使用netstat -nb 可以检测主机建立连接的程序)
6. 表示层：数据加密、压缩。
7. 应用层：产生网络流量、与用户交互，传输PDU（可以理解为文件、电影、图片什么的）。
   + HTTP、FTP、STMP

### 1.2 网络安全和OSI参考模型

> [ADSL，Asymmetric Digital Subscriber Line](https://baike.baidu.com/item/ADSL/96520)

1. 物理层安全：比如整个办公楼的网线在装修时，都预留好了，每个楼层有网线接口插座。然后这些网线都连接到地下室的服务器，来上网。哪一天要是中间几层楼出租给别的公司了，那么这些公司要是也直接用这些网线，就能访问到地下室的服务器了，这样子地下室的服务器就可能被攻击。（解决方式：可以直接在地下室服务器上拔掉这条网线接口。）
2. 数据链路层安全：ADSL、AP密码等。
   1. ADSL，用户通过电话拨号上网，需要输入账号密码。这个账号密码和应用层的邮箱系统的账号密码是不同级别的。
   2. 无线AP，无线网卡。要是没有密码，那么每个人都可以通过笔记本的无线网卡，直接WiFi蹭别人的网了。

3. 网络层安全：IP限制网络访问。比如某公司限制研发部的IP网段可以连接外网，而运维部的IP网段不能访问外网。（可以通过防火墙实现IP限制等）

7. 应用层安全：SQL注入漏洞、上传漏洞、XSS攻击等。SQL注入比如数据库模糊查询；上传漏洞比如上传PHP文件，然后被服务器解释并运行。

## 2. 物理层

### 2.1 物理层基本概念

​	物理层解决如何在连接各种计算机的传输媒体上传输**数据比特流**的问题，而不是值具体的传输媒体。

​	物理层的主要任务描述为：确定与传输媒体的接口的一些特性，即：

+ 机械特性：例接口形状、大小、引线数目
+ 电气特性：例规定电压范围（-5V~5V）
+ 功能特性：例规定-5V表示0，+5V表示1
+ 过程特性：也称规程特性，规定建立连接时各个相关部件的工作步骤

### 2.2 基础知识

1. #### 典型的数据通信模型

   输入数据 --> PC --数字比特流(bit)--> 调制解调器--模拟信号-->公用电话网--模拟信号-->调制解调器--数字比特流--> PC --> 显示数据

2. #### 相关术语

   通信的目的就是传送信息。

   数据（data）——运送信息的实体。

   信号（signal）——数据的**电气**的或**电磁**的表现。*（比如电压高低表示1和0，光纤光信号）*

   + **模拟信号**：代表消息的参数的取值是连续的。*（比如声音的波状图）*
   + **数字信号**：代表信息的参数的取值是离散的。*（比如数字0，1，2，5，10之类的）*

   **码元**（code）——在**使用时间域的波形**<u>表示数字信号</u>时，则代表不同离散数值的基本波形就成为码元。

   在数字通信中常常用时间间隔相同的符号来表示一个二进制的数字，这样的时间间隔内的信号称为二进制码元。而这个间隔被称为码元长度。**1码元可以携带nbit的信息量**。

   ```none
   # 码元 ，就这种波状的图
   ┏━━┓    ┏━━┓   ┏━━┓
   ┃  ┃▁▁┃  ┃▁▁┃  ┃
   ```

3. #### 信道

   **信道一般表示向一个方向传送信息的媒体。所以咱们说平常的通信线路往往包含一条发送信息的信道和一条接收信息的信道**。

   + 单工通信（单向通信）：只能有一个方向的通信而没有反方向的交互。*（比如无线电广播，由广播台到收音机）*
   + 半双工通信（双向交替通信）：通信的双方都可以发送信息，但不能双方同时发送（接收）。*（比如对讲机）*
   + 全双工通信（双向同时通信）：通信的双方可以同时发送和接收信息。*（比如电话）*

4. #### 基带（baseband）信号和带通（band pass）信号

   > [为什么无线电通信要将低频信号调制到高频传输？](https://blog.csdn.net/li975242487/article/details/93859799)
   >
   > [什么是高频，什么是低频？](https://zhidao.baidu.com/question/495759961339275564.html)
   >
   > [2.4GWIFI和5G WIFI 有什么区别](https://www.bilibili.com/video/BV1qJ411T7ZQ/?spm_id_from=333.788.videocard.1)
   >
   > [Wi-Fi 网络中，2.4GHz 和 5GHz 各自有哪些优缺点？](https://www.zhihu.com/question/20001576)
   >
   > 5GHz WiFi频率更高（传播范围更小）-> 不重叠的频段更多(抗干扰好，传统2.4GHz仅使用3不重叠频段，5GHz使用22个频段) -> 速度快

   + 基带信号（基本频带信号）——**来自信源的信号**。像计算机输出的代码各种文字或图片文件的数据信号都属于基带信号。**基带信号就是发出的直接表达了要传输的信息的信号**，比如我们说话的声波就是基带信号。

   + 带通信号——把基带信号经过**载波调制**后，把信号的频率范围搬移到<u>较高的频段</u>以便在信道中传输（即仅在一段频率范围内能够通过信道）。

   由于在近距离范围内基带信号的衰减不大，从而信号内容不会发生变化，因此**在传输距离较近时，计算机网络都采用基带传输方式**。如从计算机到显示器、打印机等外设的信号就是基带传输的。

   ---

   + 高频（HF，High frequency）：是频率在3 ~ 30MHz 之间的信号频率，这只是对高频的狭隘理解。而高频是包括3MHz到X00GHz的频率范围都可以称为高频。
   + 低频（LF，Low frequency）：是指频带由30 KHz到300 KHz的无线电电波。

   **频率越高，传输损耗越大（比如穿透墙壁损耗能量大，导致最后获取到的信号基本是那少部分衍射、反射过来的信号），覆盖距离越小，绕射能力越弱（原理是衍射）**。

   低频段资源紧张，低频段的无线电波主要用于广播、点视、寻呼等系统。

   > [为什么无线电通信要将低频信号调制到高频传输？](https://blog.csdn.net/li975242487/article/details/93859799)
   >
   > - 基带信号频率低，波长长，当天线的长度为无线电信号波长的 1/4 时，天线的发射和接收转换效率最高，如果不调制到高频，天线需要做得很长；
   > - 空间中的频谱资源是有限的，每个信道都严格划分给固定用途，通过载波调制可以选择合适的信道进行传输；
   > - 高频要比低频传送的成本低效率高。利用高频的不同的载波，容易实现多路通信。

5. #### 几种基本的调制方法

   1. 调幅（AM）：载波的**振幅**随基带数字信号而变化。
   2. 调频（FM）：载波的**频率**随基带数字信号而变化。
   3. 调相（PM）：载波的**初始相位**随基带数字信号而变化。

6. #### 数据通信常用编码

   1. 单极性不归零码
   2. 双极性不归零码
   3. 单极性归零码
   4. 双极性归零码
   5. 曼彻斯特编码：一个时钟周期只可表示一个bit，并且必须通过两次采样才能得到一个bit，但它能携带时钟信号，且可表示没有数据传输。（*最前面3种没数据传输了的时候和传输0的时候，都是保持在表示0的那个电压/电平，无法区分数据到底是否结束传输了，不利于同步*）
   6. 差分曼彻斯特编码：**与曼彻斯特编码相同（其实也不完全一样就是了），但抗干扰性能强于曼彻斯特编码**。

7. #### 信道的极限容量

   + 信号在实际信道（带宽受限、有噪音、干扰和失真）传输，往往接收信号波形会相对发送信号波形有不同程度的失真。

   + **奈氏准则：在任何信道中，==码元==传输的速率是有上限的，否则就会出现码间串扰的问题，使接收端对码元的判决（即识别）成为不可能**。*（比如录音后，3倍速播放，就听不清楚）*

   $$
   理想低通信道的最高码元传输速率 = 2W Baud
   $$

   ​			+ W是理想低通信道的带宽，单位HZ

   ​			+ **Baud是波特，是码元传输速率的单位**（若一个码元含有n个bit的信息量，那么1Baud = n bit/s）

   + 波特Baud与bit的区别：在**调制解调器**中经常用到波特Baud这个概念。bit是信息量，如果一个码元含有3个bit信息量，那么这个时候1波特Baud=3bit/s。

     *（比如光猫->光调制解调器，PC把数字信号通过光猫转模拟信号到网络传输，光猫在把接收到的模拟信号转回数字信号传到PC）*

8. #### 信噪比

   **香农(Shannon)用信息论的理论推导出了带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率**。
   $$
   信达的极限信息传输速率C=Wlog2(1+S/N)b/s
   $$

   + W为信道的带宽，单位HZ
   + S为信道内所传信号的平均功率
   + N为信道内部的高斯噪声功率

   香农公式标明：*（土话说就是，周围噪音大的时候，语速放慢勉强能听清楚。比如你边放音乐边讲话，别人0.5倍速听你的讲话录音能勉强听清楚）*

   1. 信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。
   2. 只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种方法来实现无差错的传输。
   3. 若信道带宽W或信噪比S/N没有上限（当然实际信道不可能如此），则信道的极限信息传输速率C也就没有上限。
   4. 实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少。

9. #### 奈氏准则和香农公式的应用范围

   ```none
   {1}输入信息->{2}[[源点]]->{3}输入数据(数字信号)->{4}[[发送器(调制)]]->{5}发送信号(模拟信号)=>{6}[[传输系统]]=>{7}接收信号(模拟信号)->{8}[[接收器(解调)]]->{9}输出数据(数字信号)->{10}[[终点]]->{11}输出信息
   
   {5}~{7},码元传输速率受奈氏准则的限制(只作用于模拟信号)
   {3}~{9},信息传输速率受香农公式的限制(作用于数字信号、模拟信号)
   ```

   简言之：

   + **奈氏准则：作用于模拟信号**（信道上的==码元==传输，前面说过了，码元即使用时间域的波形来表示数字信号，代表不同离散数数值的基本波形就是码元。）
   + **香农公式：作用于数字信号和模拟信号**

### 2.3 传输媒体

1. 导向传输媒体

   导向传输媒体中，**电磁波**沿着固定媒体传播。

   1. 双绞线

      + 屏蔽双绞线STP（抗干扰性较无屏蔽双绞线UTP更强）
      + 无屏蔽双绞线UTP

   2. 同轴电缆

      + 50Ω同轴电缆，用于数字传输，由于多用于基带传输，也叫基带同轴电缆；
      + 75Ω同轴电缆，用于模拟传输，即宽带同轴电缆；

   3. 光缆

      + 单模光纤：只传输一种电磁波模式。
      + 多模光纤：可传输多个电磁波模式。

      实际上，单模光纤和多模光纤的不同点，即纤芯直径大小，**单模细、多模粗**。**在有线点视网络中使用的光纤全是单模光纤，其传播特性好，带宽可达10GHZ**，可以在一根光纤中传输60套PAL-D电视节目。

2. 非导向传输媒体

   <u>非导向传输媒体就是指自由空间，其中的==电磁波传输被称为无线传输==</u>。**无线传输所使用的频段很广**。

   + **短波通信主要是靠电离层的反射，但短波通道的通信质量较差**。*（毕竟靠的反射，肯定会有部分损耗掉了）*

   + **微波在空间主要是直线传播**。*（地球是圆的，多建几个很高的发送塔接收和发送微波就可以了）*
     + 地面微波接力通信
     + 卫星通信

3. 集线器Hub

   + 工作特点：在网络中只起到信号放大和重发的作用，目的是扩大网络的传输范围，不具备信号的定向发送能力。

     *假如ABCD连接Hub，那么A->B的数据，B、C、D都会收到。一方面阻塞其他主机的传输线路，一方面其他主机若主动抓包数据会导致信息泄露。如果集线器总带宽12M，那么这里ABCD平均带宽只有3M*

   + 最大传输距离：100m*（不同的型号不同）*

   + 集线器是一个大的冲突域

### 2.4 ==信道复用==

1. #### 频分复用FDM(Frequency Division Multiplexing)

   ​	不同的基带模拟信号通过不同调制器（modulator）进行调制，调成高频信号后，和其他载波调制后的高频信号合并后传输。由于合并前，每个信号所使用的频带不同，获取方根据不同的调制器针对不同频带解调，既可获取之前传输的基带模拟信号。

   > 不同频段不同用户

2. #### 时分复用TDM(Time Division Multiplexing)

   时分复用是将时间划分成一段段**等长**的时分复用帧(TDM帧)。

   每一个时分复用的用户在每一个TDM帧中占用**固定序号**的时隙。

   每一个用户所占用的时隙**周期性**地出现（其周期就是TDM帧的长度对应的时间）

   TDM信号也称为等时(isochronous)信号。

   **时分复用的所有用户是在不同的时间占用同样的频带宽度**。*（可能会造成线路资源的浪费，因为即时某几个用户不交互数据了， 依旧占有时间片）*

   > 同一频段下，不同时间片不同用户

3. #### 统计时分复用STDM(Statistic TDM)

   > [统计时分多路复用]([https://baike.baidu.com/item/%E7%BB%9F%E8%AE%A1%E6%97%B6%E5%88%86%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/16600620?fromtitle=STDM&fromid=5495477&fr=aladdin](https://baike.baidu.com/item/统计时分多路复用/16600620?fromtitle=STDM&fromid=5495477&fr=aladdin))

   根据用户实际需要动态分配线路资源的时分复用方法。只有当用户有数据要传输时才给他分配线路资源，当用户暂停发送数据时，不给他分配线路资源，线路的传输能力可以被其他用户使用。采用统计时分复用时，每个用户的数据传输速率可以高于平均速率，最高可达到线路总的传输能力。

4. #### 波分复用WDM(Wavelength Division Multiplexing)

   本质上就是光的频分复用。

5. #### 码分复用CDM(Code Division Multiplexing)

   常用的名次是码分多址CDMA(Code Division Multiplexing Access)。

   各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。

   这种系统发送的信息有**很强的抗干扰能力**，其频谱类似于白噪声，不易被敌人发现。

   **每一个比特时间划分为m个短的间隔，称为码片（chip）**。
   
   *（原本1bit数据0or1需要至少m个bit去表示。码分复用也是类似频分复用一样，多个用户只要码型不同，发送的数据叠加后在网络传输，也能再根据不同的码型还原回原本的数据）*

### 2.5 数据传输系统

脉码调制PCM体制最初是在电话局之间的中继线上传送多路电话。

由于历史上的原理，PCM有两个互不兼容的国际标准，北美的24路PCM（简称T1）和欧洲的30路PCM（简称E1）。我国采用欧洲E1标准。

E1速率2.048Mb/s，而T1速率是1.544Mb/s。

<u>当需要更高的速率时，可采用复用的方法。</u>

### 2.6 宽带接入技术

> [x数字用户线]([https://baike.baidu.com/item/x%E6%95%B0%E5%AD%97%E7%94%A8%E6%88%B7%E7%BA%BF/5929900?fromtitle=xDSL&fromid=10770830&fr=aladdin](https://baike.baidu.com/item/x数字用户线/5929900?fromtitle=xDSL&fromid=10770830&fr=aladdin))

1. xDSL*（比如ADSL，拨号上网）*

   标准模拟电话信号的频带被限制在300~400Hz范围内，单用户线本身实际可通过的信号频率仍然超过1MHz。

   **xDSL技术把0~4kHz低端频谱留给传统电话使用，而把原来没有被利用的高端频谱留给用户上网使用**。

   *（0~4kHZ Voice，26~108kHz Upstream，138~1104kHz Downstream）*

2. HFC网采用结点体系结构（光纤同轴混合网HFC，Hybrid Fiber Coax）

   HFC网是目前覆盖面很广的有线电视网CATV的基础上开发的一种**居民宽带接入网**。

   HFC网除可传送CATV外，还提供电话、数据和其他宽带交互性业务。

   现有额CATV网是树形拓扑结构的同轴电缆网络，它采用**模拟技术的频分复用**对电视节目进行单向传输。而HFC网则需要对CATV网进行改造。

3. FTTx技术

   FFx（光纤到......）也是一种实现宽带居民接入网的方案。*（x可代表不同意思）*

   + 光纤到家（Fiber To The Home）：光纤一直铺设到用户家庭可能是居民接入网最后的解决方法（155Mb/s）。
   + 光纤到大楼（Fiber To The Building）：光纤进入大楼后就转为电信号，然后用电缆或双绞线分配到各用户。
   + 光纤到路边（Fiber To The Curb）：从路边到各用户可使用星形结构双绞线作为传输媒体（155Mb/s）。

## 3. 数据链路层

### 3.1 数据发送模型

主机H1 -------》（ 电话网）-------》路由器R1-------》（局域网）-------》路由器R2-------》（广域网）-------》路由器R3-------》（局域网）-------》主机H2

​	层次上看数据流动，那么只有主机H1和主机H2需要经过TCP/IP五层网络模型，而中间存储和转发的路由器R1~R3仅经过三层（物理层、数据链路层、网络层）

​	**在数据链路层，我们只关心数据帧的传输**，不关心下层物理层采用的传输介质是双绞线、同轴电缆、光纤还是其他，也不关心其信道复用技术采用的是频分多路复用FDM、时分复用TDM、统计时分复用STDM、波分复用WDM、码分多址CDMA还是其他。

### 3.2 数据链路层的信道类别

主要包括两种类别：

1. **点对点信道**：使用一对一的点对点通信方式。
2. **广播信道**：使用一对多的广播通信方式，过程较复杂。广播信道上连接的主机很多，因此必须使用专用的<u>共享信道协议</u>来协调这些主机的数据发送。

### 3.3 链路和数据链路

> [链路--百度百科]([https://baike.baidu.com/item/%E9%93%BE%E8%B7%AF/9410314?fr=aladdin](https://baike.baidu.com/item/链路/9410314?fr=aladdin))
>
> 链路指无源的点到点的物理连接。
>
> 有线通信时，链路指两个节点之间的物理线路，如电缆或光纤。无线电通信时，链路指基站和终端之间传播电磁波的路径空间。水声通信时链路指换能器和水听器之间的传播声波的路径空间。

+ 链路（link）：是从一个结点到相邻结点的一段物理链路，中间没有任何其他的交换结点。

  *一条链路只是一条通路的一个组成部分。*

+ 数据链路（data link）：除了物理线路(链路)外，还必须有**通信协议**来控制这些数据的传输。若把实现这些协议的<u>硬件和软件</u>加到链路上，就构成了数据链路。

  *现最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。*

  *一般的适配器都包括了<u>数据链路层和物理层</u>这两层的功能。*

### 3.4 数据链路层传输数据--帧

> [帧 （网络术语，表示网络传输单位）--百度百科]([https://baike.baidu.com/item/%E5%B8%A7/23750184#viewPageContent](https://baike.baidu.com/item/帧/23750184#viewPageContent))
>
> 数据在网络上是以很小的称为帧（Frame）的单位传输的，帧由几部分组成，不同的部分执行不同的功能。在以太网数据传输中，节点在发送数据之后的一定时间内，由于传输的非实时性，存在着遭遇碰撞的可能。节点发送的帧很小且2个冲突节点相距很远。
>
> [MTU最大传输单元--百度百科]([https://baike.baidu.com/item/%E6%9C%80%E5%A4%A7%E4%BC%A0%E8%BE%93%E5%8D%95%E5%85%83?fromtitle=mtu&fromid=508920](https://baike.baidu.com/item/最大传输单元?fromtitle=mtu&fromid=508920))
>
> [为什么最小帧长度是64字节](https://blog.csdn.net/jasonchen_gbd/article/details/80170309)
>
> [什么是MTU？为什么MTU值普遍都是1500？](https://blog.csdn.net/passionkk/article/details/100538418)

帧的组成大致如下：

```none
（帧头）（帧数据部分，受MTU限制大小<=1500字节【以太网标准】）（帧尾FCS）
```

*中间的帧数据部分，用于封装上层网络层的IP数据报（或其他网络层数据）。*

数据链路层数据帧传输时，向下至物理层，仍是以普通的数字信号（0101）的形式传输。*至于之后物理层是否转换数字信号为模拟信号，或者把基带信号载波调制成带通信号在高频段传输，信道复用技术采用哪种，无需数据链路层关心。*

### 3.5 数据链路层三大基本问题

1. **封装成帧**
2. **透明传输**
3. **差错检测**（差错控制）

*（现数据链路层一般仅进行差错检测，具体的差错控制->错误重传、纠错等，需要上层实现。主要是避免数据链路层过于臃肿，不利于后面的上层协议设计，且数据链路层要是自主“错误”地多次进行重传、纠错，容易拥塞网络。在某些情况下，数据链路层也提供纠错、重传机制，比如现代的**无线**通信，在链路层采用ARQ协议）*

#### 3.5.1 封装成帧

> [数据链路层的三个基本问题：封装成帧 透明传输 差错检测](https://blog.csdn.net/azsx02/article/details/69387317)

1. 概念：

+ 封装成帧（framing）就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧。

  *（<u>帧头帧尾限界处的字节数据，通常是不可打印的控制字符</u>，尽可能地避免和帧数据部分的内容冲突。）*

  *（接收端数据链路层，根据首部和尾部的标记，从（物理层）比特流中识别帧的开始和结束。）*

+ 首部和尾部的一个重要作用就是进行帧定界。

  *（当然不止如此，不同的数据链路层协议的数据帧的帧头和帧尾的功能不尽相同，通常帧尾内还包括FCS，用于判别数据是否在传输时出现错误）*

2. 思考问题：

   如果帧未发送完，发送端除了问题，只能重发该帧。接收端却接受到了“半截子帧”，它回抛弃吗？为什么？

   答：**不管是接收到含有帧头（SOH）的前半部分“子帧”还是接受到含有帧尾（EOT）的后半部分“子帧”，由于不是一个完整的帧，数据链路层都会抛弃该帧。只有完整地含有帧头（SOH）帧尾（EOT）的帧，才会被保留。**

#### 3.5.2 透明传输

1. 问题

前面**封装成帧**说了，帧头帧尾是不可打印的字符，分别是帧头SOH和帧尾EOT。

+ 若传输的数据是ASCII码中的“可打印字符（共95个）”集时，帧头帧尾的识别不会出现问题。
+ 若传输的数据不是仅由“可打印字符”组成时，就会出现问题。

eg：`【帧头SOH】(帧数据部分....EOT.....)【帧尾EOT】 `该帧被接收端接收时，会将帧数据部分含有的`EOT`字符识别成帧尾，导致后面的所有数据被当作无效帧而丢弃。=> 接收端接收`【帧头SOH】....EOT`，舍弃`.....【帧尾EOT】`。

*（传输二进制数据，比如图片、影视等二进制文件时，就容易出现上述问题）*。

2. 解决方案

+ 字节填充法（byte stuffing）
+ 字符填充法（character stuffing）
+ 零比特填充法
+ ....

这里介绍**字节填充法**：

​	发送端的数据链路层在数据中出现控制字符`SOH`或者`EOT`的前面插入一个不可打印字符*（控制字符）*`ESC`（十六进制编码1B）。

​	*==字节填充==(byte stuffing)或==字符填充==(character stuffing)——**接收端的数据链路层在数据送回网络层之前删除之前插入的转换字符。***

​	如果转义字符也出现数据当中，那么应在转移字符之前插入一个转义字符。当接收端收到连续的两个转义字符时，就删除其中前面的一个。

eg：

`【帧头SOH】(原始数据...EOT...SOH...ECS.....SOH....)【帧尾EOT】`

经过**字节填充**后，预发送的数据如下：

`【帧头SOH】(原始数据...ESC EOT...ESC SOH...ESC ECS.....ESC SOH....)【帧尾EOT】`

#### 3.5.3 差错检测

+ 概念

1. 帧在传输过程中，可能产生**比特差错**：1可能会变成0，而0也可能会变成1。*（根据前面物理层的知识，可以猜想是电压突然出现问题，或者高频信号在空气或其他介质中传输收到噪音干扰，等）*

2. 在一段时间内，传输错误的比特占所传输比特总数的比率称为**误码率**BER（Bit Error Rate）。

3. **<u>误码率与信噪比有很大的关系</u>**。*（信噪比SNR，SIGNAL-NOISE RATIO，物理层知识，S/N，S为信道内传输信号的平均功率，N为信道内部的高斯噪音功率，越高越好）*

4. 为了保证数据传输的**可靠性**（比如纠错，或者丢失重传等措施，这些实际由上层协议保证。），在计算机网络传输数据时，必须采用各种差错检测措施。

*（数据链路层只检查出错误帧并丢弃，不纠错，不重传。纠错和重传等其他动作，由上层协议实现。上层对被丢弃的帧无感知。）*

+ 应对手段

  **<u>在帧尾加入冗余校验码</u>FCS**。

  在数据链路层传送的帧中，广泛使用了**循环冗余检验CRC**技术。*(只是其中一种生成FCS的技术)*

  在发送端，先把数据划分为组。假定每组k个比特。假设带传送的一组数据M=101001（现在k=6）。我们在M的后面再添加供差错检测用的n位冗余码一起发送。

  *FSC( frame check sequence)帧检验序列的CRC计算方式*

  + 用二进制的模2运算进行2<sup>n</sup>乘M的运算，这相当于在M后面添加n个0。
  + 得到的（k+n）位的数除以事先选定好的长度为（n+1）位的除数P，得出商是Q而余数是R，余数R比除数P少1位，即R是n位。R就是CRC计算出来的FSC了。

  *（CRC的除数P和冗余码位数n由数据链路层协议商定，无需用户自己指定，理论上除数位数越多相对越可靠。大致知道计算方式即可）*

> [数据链路层的三个基本问题：封装成帧 透明传输 差错检测](https://blog.csdn.net/azsx02/article/details/69387317)
>
> 现实的通信链路都不会是理想的。传输过程中，1可能变成0, 0 可能变成1 。这就叫比特差错。——误码率。 误码率和信噪比有很大的关系。
>
> 因此，在计算机网络传输数据时，必须采用各种差错控制技术。目前在数据链路层广泛使用了循环冗余检验（CRC）的检错技术。
>
> 在数据链路层的CRC检验都是用**硬件**完成的，处理很迅速，因此不会延误数据的传输。
>
> 为什么数据链路层要以帧为单位来传送数据呢？因为如果不以帧为单位，就无法加入冗余码来进行差错检验。
>
> 传输差错分为两类：一类就是前面所说的最基本的比特差错。第二类：收到的帧出现了帧丢失、帧重复和帧失序。（停止等待协议，ARQ）。
>
> 数据链路层并不需要给网络层提供“可靠传输”的服务。<u>过去OSI的观点是：必须让数据链路层向上提供可靠传输。因此在CRC的基础上，增加了帧编号、确认和重传机制。</u>
>
> <u>而现在的互联网采用了区别对待的方法：</u>
>
> <u>对于通信质量良好的**有线**传输链路，数据链路层协议不使用确认和重传机制，即不要求数据链路层向上提供可靠传输的服务。如果在数据链路层传输数据时出现了差错并且需要进行改正，那么改正差错的任务就由上层协议（例如，运输层的TCP协议）来完成。</u>
>
> <u>对于通信质量较差的**无线**传输链路，数据链路层协议使用确认和重传机制，数据链路层向上提供可靠传输的服务。</u>

> [ARQ--百度百科](https://baike.baidu.com/item/ARQ/7402812?fr=aladdin)
>
> 自动重传请求（Automatic Repeat-reQuest，ARQ）是OSI模型中[数据链路层](https://baike.baidu.com/item/数据链路层/4329290)的错误纠正协议之一。它包括停止等待ARQ协议和连续ARQ协议，错误侦测（Error Detection）、正面确认（Positive Acknowledgment）、逾时重传（Retransmission after Timeout）与负面确认继以重传（Negative Acknowledgment and Retransmission）等机制。
>
> 传统[自动重传请求](https://baike.baidu.com/item/自动重传请求)分成为三种，即停等式(stop-and-wait）ARQ，回退n帧（go-back-n）ARQ，以及选择性重传（selective repeat）ARQ。后两种协议是[滑动窗口](https://baike.baidu.com/item/滑动窗口)技术与请求重发技术的结合，由于窗口尺寸开到足够大时，帧在线路上可以连续地流动，因此又称其为[连续ARQ协议](https://baike.baidu.com/item/连续ARQ协议)。三者的区别在于对于出错的数据[报文](https://baike.baidu.com/item/报文)的处理机制不同。三种ARQ协议中，复杂性递增，效率也递增。除了传统的ARQ，还有混合ARQ（Hybrid-ARQ）。
>
> 在现代的无线通信中，ARQ主要应用在**无线**链路层。比如，在WCDMA和cdma2000无线通信中都采用了选择性重传ARQ和混合ARQ。
>
> 优点：比较简单 。因而被广泛的应用在[分组交换](https://baike.baidu.com/item/分组交换)网络中。
>
> 缺点：1.通信信道的利用率不高，也就是说，信道还远远没有被数据比特填满。2.是需要接收方发送ACK，这样增加了网络的负担也影响了传输速度。重复发送[数据包](https://baike.baidu.com/item/数据包)来纠正错误的方法也严重的影响了它的传输速度。

+ 帧检验序列FCS

  在数据后面添加上的冗余码称为**帧检验序列FCS**（Frame Check Sequence）。

  **循环冗余检验CRC（Cyclic Redundancy Check）和帧检验序列FCS并不等同**。

  + CRC是一种常用的**检错方法**，而FCS是添加在数据后面的冗余码。*（只检错，不纠错也不重传）*
  + FCS可以用CRC这种方法得出，但CRC并非是获得FCS唯一方法。

+ 小结：CRC差错检验技术*（其实前面也都讲得很详细了，这里就再总结一下）*

  仅用循环冗余检验CRC差错检测技术只能做到**无差错接受**（accept）。

  + “无差错接受”：“凡是接收到的帧（即不包括被丢弃的帧），我们都能以非常接近于1的概率认为这些帧在传输过程中没有产生差错”。也就是“接收端数据链路层接收到的帧都没有传输差错（有差错的帧就丢弃，不接收了）”。

    *（当然这个只是理想情况，实际就算加了FCS字段，出现数据错误时也可能正好接收端FCS检验计算出来余数也是0-->0表示数据无出错，只不过概率很小。）*

  **要做到“可靠传输”（即发送什么就收到什么），就必须再加上确认和重传机制。**

  + 考虑：帧重复、帧丢失、帧乱序的情况

  **可以说“CRC是一种<u>无比特差错</u>，而不是<u>无传输差错</u>的检验机制”，**

  *（OSI/RM模型的观点：数据链路层要做到无传输差错。）<u>实际上，无线传输时就会考虑在数据链路层实现无传输差错，而有线传输通常只做到无比特差错。</u>*

### 3.6 PPP点对点协议(Point to Point Protocol)

> [PPP点对点协议(Point to Point Protocol)--百度百科](https://baike.baidu.com/item/PPP/6660214#viewPageContent)
>
> 当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接（底层up）。PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
>
> 这些分组及其响应选择一些 PPP 参数，和进行网络层配置（此前如有PAP或CHAP验证先要通过验证），NCP 给新接入的 PC机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
>
> 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。

#### 3.6.1 PPP概述

现在全世界使用得最多的数据链路层协议，是点对点协议PPP（Point to Point Protocol）。

<u>用户使用拨号电话线接入因特网时，一般都是使用PPP协议</u>。

*（补充下，前面物理层的ADSL早期也是用电话线上网，但是能够同时上网和讲电话（频段/频谱不同）；而更早的拨号上网，如果打电话就不能上网，上网就不能打电话，会占用电话线。）*

#### 3.6.2 PPP协议应该满足的要求

+ 简单——这是首要的要求
+ 封装成帧*（注意MTU限制）*
+ 透明性*（透明传输，帧头帧尾判断问题）*
+ 多种网络层协议*（会标识传输的帧数据部分是IP数据报、安全性认证PAP或者其他...）*
+ 多种类型链路*（物理层兼容，光纤、同轴电缆、双绞线等）*
+ 差错检测*（确保无差错接收，CRC等技术）*
+ 检测连接状态*（比如拨号上网，返回各种网络状态信息）*

+ 最大传输单元*（MTU，以太网的标准是<=1500Byte）*

+ 网络层地址协商*（比如拨号上网后，分配IP地址）*
+ 数据压缩协商*（比如多个0或者多个1协商怎么简写表示，然后接收后再还原）*

#### 3.6.3 PPP协议不需要满足的要求

+ 纠错
+ 流量控制
+ 序号
+ 多点线路
+ 半双工或单工链路

#### 3.6.4 PPP协议的组成

```none
3| 上层协议(如IP、IPX、AppleTalk)
-
 | 网络控制协议NCP(针对每一个网络层协议)
2| 链路控制协议LCP
 | 高级数据链路控制协议HDLC(并不是PPP的组成部分，和PPP同样是数据链路层协议)
-
1| 物理层(如 EIA/TIA-232、V.24、V.35 ISDN)
```

+ 数据链路层协议可以用于异步串行或同步串行介质
+ 它使用LCP（链路控制协议）建立并维护数据链路连接
+ 网络控制协议NCP允许在点到点连接上使用多种网络层协议

*（比如ADSL拨号上网，只有LCP身份认证通过了，才能到NCP放行网络层，给你分配IP）*

> [HDLC协议--百度百科]([https://baike.baidu.com/item/HDLC%E5%8D%8F%E8%AE%AE/9441935?fr=aladdin](https://baike.baidu.com/item/HDLC协议/9441935?fr=aladdin))
>
> HDLC协议使用统一的帧格式，运用方便；采用<u>零比特插入法</u>，易于硬件实现，且支持任意的位流传输，实现信息的透明传输；<u>全双工</u>通信，[吞吐率](https://baike.baidu.com/item/吞吐率/1555673)高，在未收到应答帧的情况下，可连续发送信息帧，提高数据链路传输的效率；采用CRC帧校验序列，可防止漏帧，提高信息传输的可靠性。 
>
> 主要有四个特点：
>
> 1·对于任何一种比特流都可透明传输。
>
> 2·较高的数据链路传输效率。
>
> 3·所有的帧都有帧校验序列（[FCS](https://baike.baidu.com/item/FCS/22504028)），传输可靠性高。
>
> 4·用统一的帧格式来实现传输。

#### 3.6.5 PPP协议帧格式

> [PPP点对点协议(Point to Point Protocol)--百度百科](https://baike.baidu.com/item/PPP/6660214#viewPageContent)
>
> PPP采用7EH作为一帧的开始和结束标志（F）；其中地址域（A）和控制域（C）取固定值（A=FFH，C=03H） ；协议域（两个字节）取0021H表示IP分组，取8021H表示网络控制数据，取C021H表示链路控制数据；帧校验域（FCS）也为两个字节，它用于对信息域的校验。若信息域中出现7EH，则转换为（7DH，5EH）两个字符。当信息域出现7DH时，则转换为（7DH，5DH）。当信息流中出现ASCII码的控制字符（即小于20H），即在该字符前加入一个7DH字符。

|      | F(7E) | A(FF) | C(03) | 协议 | 信息部分 | FCS  | F(7E) |
| ---- | ----- | ----- | ----- | ---- | -------- | ---- | ----- |
| 字节 | 1     | 1     | 1     | 2    | <=1500   | 2    | 1     |

*（地址域A取固定值FF很好理解，因为是点到点协议，所以A->B不会出现A->C的情况，链路两端的地址是固定的，没必要特地标识）*

协议字段：

| 字节数据 | 表示类型                  |
| -------- | ------------------------- |
| 0x0021   | PPP帧的信息字段，IP数据报 |
| 0xC021   | 信息字段是PPP链路控制数据 |
| 0x8021   | 表示这是网络控制数据      |
| 0xC023   | 信息字段是安全性认证PAP   |
| 0xC025   | 信息字段是LQR             |
| 0xC223   | 信息字段是安全性认证CHAP  |

#### 3.6.6 PPP的透明传输

1. **字节填充**

   问题：信息字段中出现标志字段的值，可能被误认为是“标志字段”，如何处理？

   + 将信息字段中出现的每个0x7E字节转变成2字节序列（0x7D，0x5E）
   + 若信息字段中出现一个0x7D的字节，则将其转变成2字节序列（0x7D，0x5D）
   + 若信息字段中出现ASCII码的控制字符（即数值小于0x20的字符），则在该字段前面要假如一个0x7D字节，同时将该字符的编码加以改变。

2. **零比特填充方法**

   > [零比特填充法--百度百科]([https://baike.baidu.com/item/%E9%9B%B6%E6%AF%94%E7%89%B9%E5%A1%AB%E5%85%85%E6%B3%95](https://baike.baidu.com/item/零比特填充法))

   PPP协议用在SONET/SDH链路时，是使用同步传输（一连串的比特连续传送）。这时PPP协议采用**零比特填充法**实现透明传输。

   在发送端，只要发现有5个连续1，则立即填入一个0。接收端对帧中的比特进行扫描。每当发现5个连续的1时，就把这5个连续1后的一个0删除。

*字节填充针对传输字节的情况，零比特填充针对传输比特的情况。*

> [SONET和SDH技术简介](https://blog.csdn.net/weixin_43751619/article/details/85008395)
>
> [SONET/SDH--百度百科](https://baike.baidu.com/item/SONET%2FSDH/2231992)
>
> [SONET--百度百科](https://baike.baidu.com/item/SONET/2440753?fr=aladdin)
>
> [SONET/SDH](https://www.jianshu.com/p/9bb81ff4a2ff)
>
> 简言之，即光同步数字传输网，定义了一组在光纤上传输光信号的速率和格式。

#### 3.6.7 PPP不使用序号和确认机制

​	PPP协议之所以不使用序号和确认机制时出于一下的考虑：

+ 在数据链路层出现差错的概率不大时，使用比较简单的PPP协议较为合理。
+ 在因特网环境下，PPP的信息字段放入的数据是IP数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
+ 帧检验序列FCS字段可保证无差错接受。

#### 3.6.8 PPP协议的工作状态

​	当用户拨号接入ISP时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。

​	PC机向路由器发送一系列的LCP分组（封装成多个PPP帧）。*(LCP进行身份校验)*

​	<u>这些分组及其响应选择一些PPP参数，和进行网络层配置，NCP给新接入的PC机分配一个临时的IP地址，使PC机成为因特网上的一个主机。</u>

​	<u>通信完毕时，NCP释放网络层连接，收回原来分配出去的IP地址。接着，LCP释放数据链路层连接。最后释放的是物理层的连接。</u>

> [IPCP--百度百科](https://baike.baidu.com/item/IPCP/11049069?fr=aladdin)
>
> [NCP是什么意思？](https://zhidao.baidu.com/question/583045569.html)
>
> [我想问一下，IP地址不是固定的吗，为什么说是网络控制协议NCP临时分配的呢？](https://zhidao.baidu.com/question/2272939370381570788.html)
>
> [TCP/IP：PPP点对点协议中的NCP是干什么用的](https://zhidao.baidu.com/question/258496531.html)
>
> 因特网是由大量的异构网络通过路由器相互连接起来的。而你说的网络层是指的我们用的最多的以太网的网络层，它主要运行IP协议。路由器可以连接不同的网络，即支持不同的网络层协议。所以**PPP链路的两端的NCP根据网络层的不同协议互相交换网络层特定的网络控制分组**。总之，<u>PPP协议两端的网络层可以运行不同的网络层协议，但仍然可使用同一个PPP协议进行通信</u>。
> 如果在PPP链路上运行的是IP协议，则对PPP链路的每一端配置IP协议模块（如分配IP地址）时就要使用NCP中支持IP的协议——IP控制协议**IPCP**(IP Control Protocol)。IPCP分组也封装成PPP帧在PPP链路上传送。

#### 3.6.9 PPP应用举例(cisco packet tracer模拟)

```none
Router1:
	hostname router1
	username router2 password xxx
	interface Serial0
	ip address 192.168.16.1 255.255.255.0
	clockrate 1000000
	ppp authentication chap

Router2:
	hostname router2
	username router1 password xxx
	interface Serial0
	ip address 192.168.16.2 255.255.255.0
	ppp authentication chap
```

